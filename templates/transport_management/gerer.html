{% extends "base.html" %}

{% block title %}G√©rer Transport - {{ order.numero_bon }}{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1>üöõ G√©rer Transport {{ order.numero_bon }}</h1>
                <a href="{{ url_for('transport_management.dashboard') }}" class="btn btn-outline-secondary">
                    <i class="fas fa-arrow-left"></i> Retour
                </a>
            </div>
        </div>
    </div>

    <form method="POST" action="{{ url_for('transport_management.gerer_transport_post', order_id=order.id) }}">
        <div class="row">
            <!-- Informations du transport -->
            <div class="col-md-8">
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0">üìä Informations du transport</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="statut" class="form-label">Statut du transport *</label>
                                    <select class="form-select" id="statut" name="statut" required>
                                        <option value="assigne" {% if order.statut == 'assigne' %}selected{% endif %}>Assign√©</option>
                                        <option value="en_cours" {% if order.statut == 'en_cours' %}selected{% endif %}>En cours</option>
                                        <option value="livre" {% if order.statut == 'livre' %}selected{% endif %}>Livr√©</option>
                                        <option value="annule" {% if order.statut == 'annule' %}selected{% endif %}>Annul√©</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="cout_transport" class="form-label">Co√ªt du transport (‚Ç¨)</label>
                                    <input type="number" class="form-control" id="cout_transport" name="cout_transport" 
                                           value="{{ order.cout_transport or '' }}" step="0.01">
                                </div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="distance_km" class="form-label">Distance (km) *</label>
                                    <input type="number" class="form-control" id="distance_km" name="distance_km" 
                                           value="{{ transport.distance_km or '' }}" step="0.1" required>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="emis_kg" class="form-label">√âmissions CO‚ÇÇ (kg)</label>
                                    <input type="number" class="form-control" id="emis_kg" name="emis_kg" 
                                           value="{{ transport.emis_kg or '' }}" step="0.1" readonly>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="emis_tkm" class="form-label">√âmissions par t.km (kg CO‚ÇÇ/t.km)</label>
                                    <input type="number" class="form-control" id="emis_tkm" name="emis_tkm" 
                                           value="{{ transport.emis_tkm or '' }}" step="0.1" readonly>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Calcul des √©missions -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0">üå± Calcul des √©missions carbone</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="vehicule_id" class="form-label">Type de v√©hicule</label>
                                    <select class="form-select" id="vehicule_id" name="vehicule_id">
                                        <option value="">S√©lectionner un v√©hicule...</option>
                                        {% for vehicule in vehicules %}
                                        <option value="{{ vehicule.id }}" 
                                                data-conso="{{ vehicule.consommation }}"
                                                data-emissions="{{ vehicule.emissions }}">
                                            {{ vehicule.nom }} ({{ vehicule.consommation }}L/100km)
                                        </option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="energie_id" class="form-label">Type d'√©nergie</label>
                                    <select class="form-select" id="energie_id" name="energie_id">
                                        <option value="">S√©lectionner une √©nergie...</option>
                                        {% for energie in energies %}
                                        <option value="{{ energie.id }}" 
                                                data-facteur="{{ energie.facteur_emission }}">
                                            {{ energie.nom }} ({{ energie.facteur_emission }} kg CO‚ÇÇ/L)
                                        </option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle"></i>
                            <strong>Calcul automatique :</strong> Les √©missions seront calcul√©es automatiquement 
                            en fonction du v√©hicule, de l'√©nergie et de la distance.
                        </div>
                    </div>
                </div>
            </div>

            <!-- Informations du bon -->
            <div class="col-md-4">
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0">üìã D√©tails du bon</h5>
                    </div>
                    <div class="card-body">
                        <p><strong>Num√©ro :</strong> {{ order.numero_bon }}</p>
                        <p><strong>Client :</strong> {{ order.client_nom }}</p>
                        <p><strong>Poids :</strong> {{ order.poids_kg }} kg</p>
                        <p><strong>Type :</strong> {{ order.type_colis|title }}</p>
                        <p><strong>Urgence :</strong> {{ order.urgence|title }}</p>
                        
                        <hr>
                        
                        <h6>üì§ Exp√©diteur</h6>
                        <p class="small"><strong>{{ order.expediteur_nom }}</strong></p>
                        <p class="small">{{ order.expediteur_adresse }}</p>
                        
                        <h6>üì• Destinataire</h6>
                        <p class="small"><strong>{{ order.destinataire_nom }}</strong></p>
                        <p class="small">{{ order.destinataire_adresse }}</p>
                        
                        {% if order.instructions_speciales %}
                        <hr>
                        <h6>‚ö†Ô∏è Instructions</h6>
                        <p class="small">{{ order.instructions_speciales }}</p>
                        {% endif %}
                    </div>
                </div>

                <!-- Actions -->
                <div class="card">
                    <div class="card-body">
                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save"></i> Mettre √† jour
                            </button>
                            <a href="{{ url_for('customer.voir_bon', id=order.id) }}" class="btn btn-outline-secondary">
                                <i class="fas fa-eye"></i> Voir le bon
                            </a>
                            <a href="{{ url_for('transport_management.dashboard') }}" class="btn btn-outline-secondary">
                                <i class="fas fa-list"></i> Retour √† la liste
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>

<script>
// Calcul automatique des √©missions
function calculerEmissions() {
    const vehiculeSelect = document.getElementById('vehicule_id');
    const energieSelect = document.getElementById('energie_id');
    const distanceInput = document.getElementById('distance_km');
    const poidsKg = {{ order.poids_kg }};
    
    const vehicule = vehiculeSelect.selectedOptions[0];
    const energie = energieSelect.selectedOptions[0];
    const distance = parseFloat(distanceInput.value) || 0;
    
    if (vehicule && energie && distance > 0) {
        const conso = parseFloat(vehicule.dataset.conso) || 0;
        const facteurEmission = parseFloat(energie.dataset.facteur) || 0;
        
        // Calcul des √©missions
        const consoL = (conso / 100) * distance; // Consommation en litres
        const emissionsKg = consoL * facteurEmission; // √âmissions en kg CO‚ÇÇ
        const emissionsTkm = (emissionsKg / (poidsKg / 1000)); // √âmissions par t.km
        
        document.getElementById('emis_kg').value = emissionsKg.toFixed(2);
        document.getElementById('emis_tkm').value = emissionsTkm.toFixed(2);
    }
}

// √âcouter les changements
document.getElementById('vehicule_id').addEventListener('change', calculerEmissions);
document.getElementById('energie_id').addEventListener('change', calculerEmissions);
document.getElementById('distance_km').addEventListener('input', calculerEmissions);
</script>
{% endblock %}

