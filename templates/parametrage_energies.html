{% extends "base.html" %}
{% block title %}Gestion des √ânergies ‚Äî GreenXploit{% endblock %}

{% block content %}
<div class="energies-container">
  <!-- Header -->
  <div class="page-header">
    <div class="header-content">
      <h1>‚ö° Gestion des √ânergies</h1>
      <p class="header-subtitle">G√©rez les sources d'√©nergie et leurs facteurs d'√©mission CO‚ÇÇ</p>
    </div>
    <div class="header-actions">
      <button class="btn-primary" onclick="showAddEnergieModal()">
        <span class="btn-icon">‚ûï</span>
        Ajouter une √ânergie
      </button>
    </div>
  </div>

  <!-- Filtres et recherche -->
  <div class="filters-section">
    <div class="search-box">
      <input type="text" id="search-energies" placeholder="Rechercher une √©nergie..." onkeyup="filterEnergies()">
      <span class="search-icon">üîç</span>
    </div>
  </div>

  <!-- Liste des √©nergies -->
  <div class="energies-list" id="energies-list">
    <!-- Les √©nergies seront charg√©es dynamiquement -->
  </div>

  <!-- Modal d'ajout/modification d'√©nergie -->
  <div id="energie-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 id="energie-modal-title">Ajouter une √ânergie</h2>
        <button class="close-btn" onclick="closeEnergieModal()">&times;</button>
      </div>
      
      <form id="energie-form" class="energie-form">
        <div class="form-row">
          <div class="form-group">
            <label for="energie-id">Identifiant *</label>
            <input type="text" id="energie-id" name="id" required placeholder="Ex: GAZOLE">
          </div>
          <div class="form-group">
            <label for="energie-nom">Nom *</label>
            <input type="text" id="energie-nom" name="nom" required placeholder="Ex: Gazole routier">
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label for="energie-unite">Unit√© de mesure *</label>
            <select id="energie-unite" name="unite" required>
              <option value="">S√©lectionner l'unit√©</option>
              <option value="L">Litre (L)</option>
              <option value="kg">Kilogramme (kg)</option>
              <option value="kwh">Kilowatt-heure (kWh)</option>
            </select>
          </div>
          <div class="form-group">
            <label for="energie-facteur">Facteur d'√©mission global (kg √©q. CO‚ÇÇ/unit√©)</label>
            <input type="number" id="energie-facteur" name="facteur" step="0.001" min="0" placeholder="Calcul√© automatiquement" readonly>
            <small class="form-help">Calcul√© automatiquement √† partir des facteurs d√©taill√©s (0 si non configur√©)</small>
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label for="energie-explication">Explication</label>
            <textarea id="energie-explication" name="explication" rows="3" placeholder="Description de l'√©nergie et de son facteur d'√©mission..."></textarea>
          </div>
        </div>

                 <div class="form-row">
           <div class="form-group">
             <label for="energie-lien-source">Lien source</label>
             <input type="url" id="energie-lien-source" name="lien_source" placeholder="https://...">
           </div>
         </div>
 
         <div class="form-row">
           <div class="form-group">
             <button type="button" class="btn-facteurs-inline" onclick="showFacteursModalFromEnergieForm()">
               <span class="btn-icon">üìä</span>
               Configurer les Facteurs d'√âmission
             </button>
             <small class="form-help">Configurez les √©missions d√©taill√©es (phase amont, phase fonctionnement)</small>
           </div>
         </div>
 
         <div class="form-actions">
           <button type="submit" class="btn-save">üíæ Sauvegarder</button>
           <button type="button" class="btn-cancel" onclick="closeEnergieModal()">‚ùå Annuler</button>
         </div>
      </form>
    </div>
  </div>

  <!-- Modal des facteurs d'√©mission d√©taill√©s -->
  <div id="facteurs-modal" class="modal">
    <div class="modal-content facteurs-modal-content">
      <div class="modal-header">
        <h2 id="facteurs-modal-title">Configurer les Facteurs d'√âmission</h2>
        <button class="close-btn" onclick="closeFacteursModal()">&times;</button>
      </div>
      
      <div class="facteurs-content">
        <!-- En-t√™te compact -->
        <div class="energie-info-compact">
          <h3 id="energie-nom-facteurs"></h3>
          <span class="energie-unite-badge" id="energie-unite-facteurs"></span>
        </div>

        <!-- Layout en 2 colonnes -->
        <div class="facteurs-layout">
          <!-- Colonne gauche : Valeurs de calcul -->
          <div class="facteurs-column">
            <div class="section-title-compact">
              <h4>üìä Valeurs de Calcul</h4>
              <p>Calcul automatique des √©missions</p>
            </div>

            <form id="facteurs-form" class="facteurs-form-compact">
              <div class="form-group-compact">
                <label for="facteur-phase-amont">Phase amont *</label>
                <input type="number" id="facteur-phase-amont" name="phase_amont" required step="0.001" min="0" placeholder="0.66">
                <small class="form-help-compact">kg √©q. CO‚ÇÇ/unit√©</small>
              </div>
              
              <div class="form-group-compact">
                <label for="facteur-phase-fonctionnement">Phase fonctionnement *</label>
                <input type="number" id="facteur-phase-fonctionnement" name="phase_fonctionnement" required step="0.001" min="0" placeholder="2.51">
                <small class="form-help-compact">kg √©q. CO‚ÇÇ/unit√©</small>
              </div>

              <div class="form-group-compact total-group">
                <label for="facteur-total">Total calcul√©</label>
                <input type="number" id="facteur-total" name="total" step="0.001" min="0" placeholder="Calcul√© automatiquement" readonly>
                <small class="form-help-compact">kg √©q. CO‚ÇÇ/unit√©</small>
              </div>
              
              <div class="form-group-compact">
                <label for="energie-facteur-modal">Facteur Global</label>
                <input type="number" id="energie-facteur-modal" name="facteur_global" step="0.001" min="0" placeholder="Calcul√© automatiquement" readonly>
                <small class="form-help-compact">kg √©q. CO‚ÇÇ/unit√©</small>
              </div>
            </form>
          </div>

          <!-- Colonne droite : Valeurs suppl√©mentaires -->
          <div class="facteurs-column">
            <div class="section-title-compact">
              <h4>‚ûï Valeurs Suppl√©mentaires</h4>
              <p>Valeurs personnalis√©es</p>
            </div>

            <!-- Bouton pour ajouter une nouvelle valeur -->
            <div class="add-value-section-compact">
              <button type="button" class="btn-add-value-compact" onclick="showAddValueForm()">
                <span class="btn-icon">‚ûï</span>
                Ajouter une Valeur
              </button>
            </div>

            <!-- Formulaire d'ajout de valeur (cach√© par d√©faut) -->
            <div id="add-value-form" class="add-value-form-compact" style="display: none;">
              <h5>Nouvelle Valeur</h5>
              <div class="form-group-compact">
                <label for="new-value-name">Nom *</label>
                <input type="text" id="new-value-name" placeholder="√âmissions indirectes">
              </div>
              <div class="form-group-compact">
                <label for="new-value-valeur">Valeur *</label>
                <input type="number" id="new-value-valeur" step="0.001" min="0" placeholder="0.85">
              </div>
              <div class="form-group-compact">
                <label for="new-value-unite">Unit√©</label>
                <input type="text" id="new-value-unite" value="kg √©q. CO‚ÇÇ">
              </div>
              <div class="form-group-compact">
                <label for="new-value-description">Description</label>
                <input type="text" id="new-value-description" placeholder="Description">
              </div>
              <div class="form-actions-inline-compact">
                <button type="button" class="btn-save-compact" onclick="addNewValue()">üíæ Ajouter</button>
                <button type="button" class="btn-cancel-compact" onclick="hideAddValueForm()">‚ùå Annuler</button>
              </div>
            </div>

            <!-- Liste des valeurs suppl√©mentaires -->
            <div class="values-list-section-compact">
              <h5>Valeurs Configur√©es</h5>
              <div id="values-list" class="values-list-compact">
                <!-- Les valeurs seront charg√©es dynamiquement -->
              </div>
            </div>
          </div>
        </div>

        <!-- Actions principales -->
        <div class="form-actions-compact">
          <button type="submit" form="facteurs-form" class="btn-save">üíæ Sauvegarder Tout</button>
          <button type="button" class="btn-cancel" onclick="closeFacteursModal()">‚ùå Annuler</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Scripts JavaScript -->
<script>
let energies = [];
let currentEditId = null;
let currentEnergieForFacteurs = null;

// Flag pour indiquer si des facteurs ont √©t√© configur√©s
window.facteursConfigures = false;

// Charger les √©nergies au d√©marrage
document.addEventListener('DOMContentLoaded', function() {
  loadEnergies();
  
  // Ajouter les √©couteurs d'√©v√©nements pour le calcul automatique du total
  document.getElementById('facteur-phase-amont').addEventListener('input', calculateTotalFacteur);
  document.getElementById('facteur-phase-fonctionnement').addEventListener('input', calculateTotalFacteur);
  
  // Ajouter des √©v√©nements pour le d√©bogage
  document.getElementById('facteur-phase-amont').addEventListener('change', function() {
    console.log('üìù Phase amont modifi√©e:', this.value);
  });
  
  document.getElementById('facteur-phase-fonctionnement').addEventListener('change', function() {
    console.log('üìù Phase fonctionnement modifi√©e:', this.value);
  });

// Ajouter la validation personnalis√©e pour √©viter les alertes du navigateur
document.getElementById('facteur-phase-amont').addEventListener('invalid', function(e) {
  e.preventDefault();
  this.setCustomValidity('');
});
document.getElementById('facteur-phase-fonctionnement').addEventListener('invalid', function(e) {
  e.preventDefault();
  this.setCustomValidity('');
});
});

// Calculer automatiquement le total des facteurs d'√©mission
function calculateTotalFacteur() {
  const phaseAmont = parseFloat(document.getElementById('facteur-phase-amont').value) || 0;
  const phaseFonctionnement = parseFloat(document.getElementById('facteur-phase-fonctionnement').value) || 0;
  const total = Math.round((phaseAmont + phaseFonctionnement) * 1000) / 1000; // Arrondir √† 3 d√©cimales
  
  console.log('üßÆ Calcul des facteurs d\'√©mission:');
  console.log('- Phase amont:', phaseAmont);
  console.log('- Phase fonctionnement:', phaseFonctionnement);
  console.log('- Total calcul√©:', total);
  
  // D√©tecter si des facteurs ont √©t√© configur√©s
  if (total > 0) {
    window.facteursConfigures = true;
    console.log('üéØ Facteurs configur√©s d√©tect√©s - flag activ√©');
  }
  
  // Afficher le total calcul√© (toujours bas√© sur les phases)
  const totalField = document.getElementById('facteur-total');
  if (totalField) {
    totalField.value = total.toFixed(3);
    console.log('üìä Total affich√©:', total.toFixed(3));
  }
  
  // Mettre √† jour automatiquement le facteur global dans le formulaire principal
  const facteurGlobalField = document.getElementById('energie-facteur');
  if (facteurGlobalField) {
    facteurGlobalField.value = total.toFixed(3);
    console.log('‚úÖ Facteur global mis √† jour dans le formulaire principal:', total.toFixed(3));
  }
  
  // Mettre √† jour aussi le facteur global dans le modal des facteurs
  const facteurGlobalModal = document.getElementById('energie-facteur-modal');
  if (facteurGlobalModal) {
    facteurGlobalModal.value = total.toFixed(3);
    console.log('‚úÖ Facteur global mis √† jour dans le modal:', total.toFixed(3));
  }
  
  return total;
}

// Mettre √† jour le facteur global d'une √©nergie apr√®s sauvegarde des facteurs
function updateEnergieFacteur(energieId, nouveauFacteur) {
  const energie = energies.find(e => e.id === energieId);
  if (energie) {
    energie.facteur = nouveauFacteur;
    
    // Mettre √† jour via l'API
    fetch(`/api/energies/${energieId}`, {
      method: 'PUT',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        nom: energie.nom,
        identifiant: energie.identifiant,
        unite: energie.unite,
        facteur: nouveauFacteur,
        description: energie.description
      })
    })
    .then(response => response.json())
    .then(result => {
      if (result.success) {
        console.log('Facteur global mis √† jour avec succ√®s');
        loadEnergies(); // Recharger la liste
      } else {
        console.error('Erreur lors de la mise √† jour du facteur global:', result.error);
      }
    })
    .catch(error => {
      console.error('Erreur lors de la mise √† jour du facteur global:', error);
    });
  }
}

// Charger la liste des √©nergies
function loadEnergies() {
  console.log('üîÑ Chargement des √©nergies...');
  fetch('/api/energies')
    .then(response => response.json())
    .then(result => {
      console.log('üì• Donn√©es re√ßues de l\'API:', result);
      
      if (result.success && result.energies) {
        // L'API retourne {success: true, energies: [...]}
        energies = result.energies.map(energie => {
          let phaseAmont = parseFloat(energie.phase_amont) || 0;
          let phaseFonctionnement = parseFloat(energie.phase_fonctionnement) || 0;
          
          // Si les phases ne sont pas configur√©es mais qu'il y a un facteur global,
          // r√©partir le facteur global entre les deux phases (80% fonctionnement, 20% amont)
          if (phaseAmont === 0 && phaseFonctionnement === 0 && energie.facteur && energie.facteur > 0) {
            phaseFonctionnement = Math.round((energie.facteur * 0.8) * 1000) / 1000; // 80% pour la phase fonctionnement
            phaseAmont = Math.round((energie.facteur * 0.2) * 1000) / 1000; // 20% pour la phase amont
            console.log(`üîÑ R√©partition automatique du facteur ${energie.facteur} pour ${energie.nom}:`, {
              phase_amont: phaseAmont,
              phase_fonctionnement: phaseFonctionnement
            });
          }
          
          const total = phaseAmont + phaseFonctionnement;
          
          console.log(`üìä Mapping √©nergie ${energie.nom}:`, {
            phase_amont: phaseAmont,
            phase_fonctionnement: phaseFonctionnement,
            total: total,
            facteur: energie.facteur
          });
          
          return {
            id: energie.id,
            nom: energie.nom,
            identifiant: energie.identifiant,
            facteur: energie.facteur,
            description: energie.description,
            unite: energie.unite || 'L',
            phase_amont: phaseAmont,
            phase_fonctionnement: phaseFonctionnement,
            total: total,
            donnees_supplementaires: energie.donnees_supplementaires || {}
          };
        });
        
        console.log('‚úÖ √ânergies mapp√©es avec succ√®s:', energies);
      } else {
        // Fallback pour l'ancien format
        energies = Object.entries(result).map(([id, data]) => ({ id, ...data }));
        console.log('‚ö†Ô∏è Utilisation du format fallback');
      }
      
      console.log('üéØ √ânergies format√©es:', energies);
      
      // Sauvegarder l'√©tat de recherche actuel
      const currentSearch = document.getElementById('search-energies').value;
      
      // Afficher les √©nergies
      displayEnergies(energies);
      
      // Restaurer la recherche si elle existait
      if (currentSearch) {
        document.getElementById('search-energies').value = currentSearch;
        filterEnergies();
      }
      
      console.log('‚úÖ Affichage des √©nergies termin√©');
    })
    .catch(error => {
      console.error('‚ùå Erreur lors du chargement des √©nergies:', error);
      showNotification('Erreur lors du chargement des √©nergies', 'error');
    });
}

// Afficher la liste des √©nergies
function displayEnergies(energiesToShow) {
  const container = document.getElementById('energies-list');
  
  if (energiesToShow.length === 0) {
    container.innerHTML = '<div class="no-energies">Aucune √©nergie trouv√©e</div>';
    return;
  }
  
  container.innerHTML = energiesToShow.map(energie => {
    // Calculer le total des √©missions
    const total = (energie.phase_amont || 0) + (energie.phase_fonctionnement || 0) || energie.facteur || 0;
    
    return `
      <div class="energie-card" data-id="${energie.id}" data-energie-id="${energie.id}">
        <div class="energie-header">
          <div class="energie-info">
            <h3>${energie.nom || 'Sans nom'}</h3>
            <span class="energie-id">${energie.identifiant || energie.id}</span>
          </div>
          <div class="energie-badge">
            <span class="badge-unit">${energie.unite || 'N/A'}</span>
          </div>
        </div>
        
        <div class="energie-details">
          <div class="detail-row total-emissions">
            <span class="detail-label">Total des √©missions:</span>
            <span class="detail-value total-emissions-value">${total.toFixed(3)} kg √©q. CO‚ÇÇ/${energie.unite || 'unit√©'}</span>
          </div>
        </div>
        
        <div class="energie-actions">
          <button class="btn-edit" onclick="editEnergie('${energie.id}')">
            <span class="btn-icon">‚úèÔ∏è</span>
            Modifier
          </button>
          <button class="btn-delete" onclick="deleteEnergie('${energie.id}')">
            <span class="btn-icon">üóëÔ∏è</span>
            Supprimer
          </button>
        </div>
      </div>
    `;
  }).join('');
}

// Filtrer les √©nergies
function filterEnergies() {
  const searchTerm = document.getElementById('search-energies').value.toLowerCase();
  
  const filtered = energies.filter(energie => {
    return energie.nom.toLowerCase().includes(searchTerm) || 
           energie.id.toLowerCase().includes(searchTerm);
  });
  
  displayEnergies(filtered);
}

// Afficher le modal d'ajout
function showAddEnergieModal() {
  currentEditId = null;
  document.getElementById('energie-modal-title').textContent = 'Ajouter une √ânergie';
  document.getElementById('energie-form').reset();
  document.getElementById('energie-modal').style.display = 'block';
}

// Afficher le modal de modification
function editEnergie(energieId) {
  console.log('=== D√âBUT √âDITION √âNERGIE ===');
  console.log('Tentative d\'√©dition de l\'√©nergie avec ID:', energieId);
  console.log('Type de l\'ID re√ßu:', typeof energieId);
  console.log('√ânergies disponibles:', energies);
  console.log('Nombre d\'√©nergies:', energies.length);
  
  // Chercher l'√©nergie par ID num√©rique ou par identifiant
  const energie = energies.find(e => {
    console.log('Comparaison:', e.id, energieId, e.identifiant);
    return e.id == energieId || e.identifiant === energieId;
  });
  
  if (!energie) {
    console.error('‚ùå √ânergie non trouv√©e pour l\'ID:', energieId);
    console.error('√ânergies dans la liste:', energies);
    showNotification('√ânergie non trouv√©e', 'error');
    return;
  }
  
  console.log('‚úÖ √ânergie trouv√©e pour √©dition:', energie);
  
  currentEditId = energie.id; // Toujours utiliser l'ID num√©rique de la base
  document.getElementById('energie-modal-title').textContent = `Modifier l'√ânergie ${energie.identifiant || energie.id}`;
  
  // Remplir le formulaire
  document.getElementById('energie-id').value = energie.identifiant || energie.id || '';
  document.getElementById('energie-nom').value = energie.nom || '';
  document.getElementById('energie-unite').value = energie.unite || '';
  document.getElementById('energie-facteur').value = energie.facteur || '';
  document.getElementById('energie-explication').value = energie.description || '';
  document.getElementById('energie-lien-source').value = energie.lien_source || '';
  
  console.log('Formulaire rempli avec currentEditId:', currentEditId);
  console.log('=== FIN √âDITION √âNERGIE ===');
  
  document.getElementById('energie-modal').style.display = 'block';
}

// Afficher le modal des facteurs d'√©mission
function showFacteursModal(energieId) {
  console.log('=== OUVERTURE MODAL FACTEURS ===');
  console.log('üîç ID d\'√©nergie re√ßu:', energieId, 'Type:', typeof energieId);
  
  // S'assurer que l'ID est num√©rique
  energieId = parseInt(energieId);
  if (isNaN(energieId)) {
    console.error('‚ùå ID d\'√©nergie invalide:', energieId);
    showNotification('ID d\'√©nergie invalide', 'error');
    return;
  }
  
  console.log('üî¢ ID d\'√©nergie pars√©:', energieId);
  
  const energie = energies.find(e => e.id === energieId);
  if (!energie) {
    console.error('‚ùå √ânergie non trouv√©e pour l\'ouverture du modal des facteurs');
    showNotification('√ânergie non trouv√©e', 'error');
    return;
  }
  
  console.log('‚úÖ √ânergie trouv√©e pour le modal:', energie);
  
  // S'assurer que l'ID est num√©rique et d√©finir la variable globale
  currentEnergieForFacteurs = parseInt(energieId);
  console.log('üéØ currentEnergieForFacteurs d√©fini √†:', currentEnergieForFacteurs);
  
  document.getElementById('energie-nom-facteurs').textContent = energie.nom;
  document.getElementById('energie-unite-facteurs').textContent = `Unit√©: ${energie.unite || 'L'}`;
  
  // Remplir le formulaire des facteurs avec les valeurs existantes
  const phaseAmont = Math.round((energie.phase_amont || 0) * 1000) / 1000;
  const phaseFonctionnement = Math.round((energie.phase_fonctionnement || 0) * 1000) / 1000;
  
  document.getElementById('facteur-phase-amont').value = phaseAmont;
  document.getElementById('facteur-phase-fonctionnement').value = phaseFonctionnement;
  
  console.log('üìä Valeurs charg√©es depuis la base:');
  console.log('- Phase amont:', phaseAmont);
  console.log('- Phase fonctionnement:', phaseFonctionnement);
  
  // Calculer automatiquement le total et le facteur global
  calculateTotalFacteur();
  
  console.log('üìä Donn√©es remplies dans le modal:');
  console.log('- Phase amont:', energie.phase_amont);
  console.log('- Phase fonctionnement:', energie.phase_fonctionnement);
  console.log('- Total:', energie.total || energie.facteur);
  console.log('üéØ currentEnergieForFacteurs final:', currentEnergieForFacteurs);
  
  // Charger et afficher les valeurs suppl√©mentaires
  loadEnergieValues(energieId);
  
  document.getElementById('facteurs-modal').style.display = 'block';
  console.log('=== FIN OUVERTURE MODAL FACTEURS ===');
}

// Afficher le modal des facteurs depuis le formulaire d'√©nergie
function showFacteursModalFromEnergieForm() {
  // R√©cup√©rer les donn√©es du formulaire d'√©nergie
  const energieId = document.getElementById('energie-id').value;
  const energieNom = document.getElementById('energie-nom').value;
  const energieUnite = document.getElementById('energie-unite').value;
  
  if (!energieId || !energieNom || !energieUnite) {
    alert('Veuillez d\'abord remplir l\'identifiant, le nom et l\'unit√© de l\'√©nergie');
    return;
  }
  
  // Si c'est une nouvelle √©nergie, utiliser les donn√©es du formulaire
  if (!currentEditId) {
    console.log('üÜï Nouvelle √©nergie d√©tect√©e - configuration des facteurs');
    // Pour une nouvelle √©nergie, on peut configurer les facteurs mais on utilise un ID temporaire
    currentEnergieForFacteurs = 'new'; // Marqueur pour nouvelle √©nergie
    console.log('üéØ currentEnergieForFacteurs d√©fini √†:', currentEnergieForFacteurs);
    
    document.getElementById('energie-nom-facteurs').textContent = energieNom;
    document.getElementById('energie-unite-facteurs').textContent = `Unit√©: ${energieUnite}`;
    
    // Vider les champs des facteurs pour une nouvelle √©nergie
    document.getElementById('facteur-phase-amont').value = '';
    document.getElementById('facteur-phase-fonctionnement').value = '';
    document.getElementById('facteur-total').value = '';
    
    // Vider la liste des valeurs suppl√©mentaires pour une nouvelle √©nergie
    displayEnergieValues({});
    
    console.log('‚úÖ Modal des facteurs ouvert pour nouvelle √©nergie (mode pr√©visualisation)');
  } else {
    // Si c'est une modification, utiliser les donn√©es existantes
    const energie = energies.find(e => e.id == currentEditId);
    if (energie) {
      console.log('‚úÖ √ânergie existante trouv√©e pour modification:', energie);
      currentEnergieForFacteurs = energie.id; // Utiliser l'ID num√©rique de la base
      console.log('üéØ currentEnergieForFacteurs d√©fini √†:', currentEnergieForFacteurs);
      
      document.getElementById('energie-nom-facteurs').textContent = energie.nom;
      document.getElementById('energie-unite-facteurs').textContent = `Unit√©: ${energie.unite || 'L'}`;
      
      // Remplir avec les valeurs existantes
      const phaseAmont = Math.round((energie.phase_amont || 0) * 1000) / 1000;
      const phaseFonctionnement = Math.round((energie.phase_fonctionnement || 0) * 1000) / 1000;
      
      document.getElementById('facteur-phase-amont').value = phaseAmont;
      document.getElementById('facteur-phase-fonctionnement').value = phaseFonctionnement;
      
      console.log('üìä Valeurs charg√©es pour modification:');
      console.log('- Phase amont:', phaseAmont);
      console.log('- Phase fonctionnement:', phaseFonctionnement);
      
      // Stocker le facteur global existant dans les attributs data
      const totalField = document.getElementById('facteur-total');
      if (totalField) {
        totalField.setAttribute('data-facteur-existant', energie.facteur || '0');
      }
      
      // Calculer automatiquement le total et le facteur global
      calculateTotalFacteur();
      
      // Mettre √† jour le facteur global avec la valeur existante
      const facteurGlobalField = document.getElementById('energie-facteur');
      const facteurGlobalModal = document.getElementById('energie-facteur-modal');
      
      if (facteurGlobalField) {
        facteurGlobalField.value = energie.facteur || '';
        facteurGlobalField.setAttribute('data-facteur-existant', energie.facteur || '0');
      }
      
      if (facteurGlobalModal) {
        facteurGlobalModal.value = energie.facteur || '';
        facteurGlobalModal.setAttribute('data-facteur-existant', energie.facteur || '0');
      }
      
      console.log('üíæ Facteur global existant sauvegard√©:', energie.facteur);
      
      // Charger les valeurs suppl√©mentaires existantes
      loadEnergieValues(energie.id);
      
      console.log('üìä Donn√©es charg√©es pour modification:');
      console.log('- Phase amont:', energie.phase_amont);
      console.log('- Phase fonctionnement:', energie.phase_fonctionnement);
      console.log('- Total:', energie.total || energie.facteur);
      console.log('üéØ currentEnergieForFacteurs final:', currentEnergieForFacteurs);
      console.log('‚úÖ Modal des facteurs ouvert pour √©nergie existante:', energie.id);
    } else {
      console.error('‚ùå √ânergie non trouv√©e pour modification. currentEditId:', currentEditId);
      alert('√ânergie non trouv√©e. Veuillez d\'abord sauvegarder l\'√©nergie.');
      return;
    }
  }
  
  document.getElementById('facteurs-modal').style.display = 'block';
}

// Fermer le modal d'√©nergie
function closeEnergieModal() {
  document.getElementById('energie-modal').style.display = 'none';
  currentEditId = null;
}

// Fermer le modal des facteurs
function closeFacteursModal() {
  // Synchroniser le facteur global avec le total calcul√©
  const total = document.getElementById('facteur-total').value;
  if (total && total !== '0.000') {
    const facteurGlobalField = document.getElementById('energie-facteur');
    if (facteurGlobalField) {
      facteurGlobalField.value = total;
    }
  }
  
  // Cacher le formulaire d'ajout de valeur
  hideAddValueForm();
  
  document.getElementById('facteurs-modal').style.display = 'none';
  currentEnergieForFacteurs = null;
}

// Afficher le formulaire d'ajout de valeur
function showAddValueForm() {
  document.getElementById('add-value-form').style.display = 'block';
  // Vider les champs
  document.getElementById('new-value-name').value = '';
  document.getElementById('new-value-valeur').value = '';
  document.getElementById('new-value-unite').value = 'kg √©q. CO‚ÇÇ';
  document.getElementById('new-value-description').value = '';
}

// Cacher le formulaire d'ajout de valeur
function hideAddValueForm() {
  document.getElementById('add-value-form').style.display = 'none';
}

// Charger les valeurs suppl√©mentaires d'une √©nergie
function loadEnergieValues(energieId) {
  // Pour l'instant, on utilise les donn√©es existantes
  // Plus tard, on pourra appeler l'API pour r√©cup√©rer les valeurs
  const energie = energies.find(e => e.id === energieId);
  if (!energie) return;
  
  // Afficher les valeurs existantes (si disponibles)
  displayEnergieValues(energie.donnees_supplementaires || {});
}

// Afficher les valeurs suppl√©mentaires
function displayEnergieValues(values) {
  const container = document.getElementById('values-list');
  
  if (!values || Object.keys(values).length === 0) {
    container.innerHTML = '<div class="no-values">Aucune valeur suppl√©mentaire configur√©e</div>';
    return;
  }
  
  container.innerHTML = Object.entries(values).map(([name, data]) => `
    <div class="value-item-compact" data-name="${name}">
      <div class="value-info-compact">
        <div class="value-name-compact">${name}</div>
        <div class="value-details-compact">
          <span class="value-valeur-compact">${data.valeur} ${data.unite || 'kg √©q. CO‚ÇÇ'}</span>
          ${data.description ? `<span class="value-description-compact">${data.description}</span>` : ''}
        </div>
      </div>
      <div class="value-actions-compact">
        <button class="btn-edit-small-compact" onclick="editValue('${name}')" title="Modifier">
          ‚úèÔ∏è
        </button>
        <button class="btn-delete-small-compact" onclick="deleteValue('${name}')" title="Supprimer">
          üóëÔ∏è
        </button>
      </div>
    </div>
  `).join('');
}

// Ajouter une nouvelle valeur
function addNewValue() {
  const name = document.getElementById('new-value-name').value.trim();
  const valeur = parseFloat(document.getElementById('new-value-valeur').value);
  const unite = document.getElementById('new-value-unite').value.trim();
  const description = document.getElementById('new-value-description').value.trim();
  
  if (!name || isNaN(valeur)) {
    alert('Veuillez remplir le nom et la valeur');
    return;
  }
  
  const newValue = {
    nom: name,
    valeur: valeur,
    unite: unite || 'kg √©q. CO‚ÇÇ',
    description: description
  };
  
  // Appeler l'API pour ajouter la valeur
  fetch(`/api/energies/${currentEnergieForFacteurs}/donnees`, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
    },
    body: JSON.stringify(newValue)
  })
  .then(response => response.json())
  .then(result => {
    if (result.success) {
      showNotification('Valeur ajout√©e avec succ√®s', 'success');
      hideAddValueForm();
      // Recharger les valeurs
      loadEnergieValues(currentEnergieForFacteurs);
      // Recharger la liste des √©nergies
      loadEnergies();
    } else {
      showNotification(`Erreur: ${result.error}`, 'error');
    }
  })
  .catch(error => {
    console.error('Erreur lors de l\'ajout de la valeur:', error);
    showNotification('Erreur lors de l\'ajout de la valeur', 'error');
  });
}

// Modifier une valeur existante
function editValue(valueName) {
  // Pour l'instant, on utilise un prompt simple
  // Plus tard, on pourra cr√©er un modal d'√©dition
  const newValeur = prompt(`Nouvelle valeur pour "${valueName}" (kg √©q. CO‚ÇÇ):`);
  if (newValeur === null || isNaN(parseFloat(newValeur))) return;
  
  const energie = energies.find(e => e.id === currentEnergieForFacteurs);
  if (!energie || !energie.donnees_supplementaires) return;
  
  // Mettre √† jour la valeur
  energie.donnees_supplementaires[valueName].valeur = parseFloat(newValeur);
  
  // Sauvegarder via l'API des facteurs
  const facteursData = {
    phase_amont: parseFloat(document.getElementById('facteur-phase-amont').value) || 0,
    phase_fonctionnement: parseFloat(document.getElementById('facteur-phase-fonctionnement').value) || 0,
    total: parseFloat(document.getElementById('facteur-total').value) || 0,
    donnees_supplementaires: energie.donnees_supplementaires
  };
  
  fetch(`/api/energies/${currentEnergieForFacteurs}/facteurs`, {
    method: 'PUT',
    headers: {
      'Content-Type': 'application/json',
    },
    body: JSON.stringify(facteursData)
  })
  .then(response => response.json())
  .then(result => {
    if (result.success) {
      showNotification('Valeur modifi√©e avec succ√®s', 'success');
      loadEnergieValues(currentEnergieForFacteurs);
      loadEnergies();
    } else {
      showNotification(`Erreur: ${result.error}`, 'error');
    }
  })
  .catch(error => {
    console.error('Erreur lors de la modification:', error);
    showNotification('Erreur lors de la modification', 'error');
  });
}

// Supprimer une valeur
function deleteValue(valueName) {
  if (!confirm(`√ätes-vous s√ªr de vouloir supprimer la valeur "${valueName}" ?`)) return;
  
  fetch(`/api/energies/${currentEnergieForFacteurs}/donnees/${encodeURIComponent(valueName)}`, {
    method: 'DELETE'
  })
  .then(response => response.json())
  .then(result => {
    if (result.success) {
      showNotification('Valeur supprim√©e avec succ√®s', 'success');
      loadEnergieValues(currentEnergieForFacteurs);
      loadEnergies();
    } else {
      showNotification(`Erreur: ${result.error}`, 'error');
    }
  })
  .catch(error => {
    console.error('Erreur lors de la suppression:', error);
    showNotification('Erreur lors de la suppression', 'error');
  });
}

// Supprimer une √©nergie
function deleteEnergie(energieId) {
  if (confirm(`√ätes-vous s√ªr de vouloir supprimer l'√©nergie ${energieId} ?`)) {
    // Appeler l'API de suppression
    fetch(`/api/energies/${energieId}`, {
      method: 'DELETE',
      headers: {
        'Content-Type': 'application/json',
      }
    })
    .then(response => response.json())
    .then(result => {
      if (result.success) {
        showNotification('√ânergie supprim√©e avec succ√®s', 'success');
        // Recharger la liste des √©nergies
        loadEnergies();
      } else {
        showNotification(`Erreur: ${result.error}`, 'error');
      }
    })
    .catch(error => {
      console.error('Erreur lors de la suppression:', error);
      showNotification('Erreur lors de la suppression', 'error');
    });
  }
}

// Gestionnaire de soumission du formulaire d'√©nergie
document.getElementById('energie-form').addEventListener('submit', function(e) {
  e.preventDefault();
  
  const formData = new FormData(e.target);
  const isEdit = !!currentEditId; // V√©rifier si c'est une modification
  
  // R√©cup√©rer les donn√©es du formulaire
  const energieData = {
    identifiant: formData.get('id'), // L'API attend 'identifiant'
    nom: formData.get('nom'),
    facteur: formData.get('facteur') ? parseFloat(formData.get('facteur')) : null,
    description: formData.get('explication'), // L'API attend 'description'
    unite: formData.get('unite')
  };
  
  // V√©rifier que le facteur global est renseign√©
  if (!energieData.facteur || energieData.facteur <= 0) {
    showNotification('‚ùå Erreur: Le facteur global doit √™tre renseign√© et sup√©rieur √† 0', 'error');
    return;
  }
  
  // Validation des donn√©es obligatoires
  if (!energieData.identifiant || !energieData.nom) {
    showNotification('Erreur: Identifiant et nom sont obligatoires', 'error');
    return;
  }
  
  // Nettoyer les valeurs vides
  if (energieData.description === '') {
    energieData.description = null;
  }
  
  console.log('üì§ Donn√©es √† envoyer √† l\'API:', energieData);
  console.log('Mode:', isEdit ? 'Modification' : 'Cr√©ation');
  
  // D√©terminer l'URL et la m√©thode selon le mode
  const url = isEdit ? `/api/energies/${currentEditId}` : '/api/energies';
  const method = isEdit ? 'PUT' : 'POST';
  
  // Sauvegarder l'√©nergie via l'API
  console.log('üåê URL de l\'API:', url);
  console.log('üì° M√©thode HTTP:', method);
  console.log('üì¶ Corps de la requ√™te:', JSON.stringify(energieData, null, 2));
  
  fetch(url, {
    method: method,
    headers: {
      'Content-Type': 'application/json',
    },
    body: JSON.stringify(energieData)
  })
  .then(response => {
    console.log('R√©ponse HTTP:', response.status, response.statusText);
    if (!response.ok) {
      throw new Error(`HTTP ${response.status}: ${response.statusText}`);
    }
    return response.json();
  })
  .then(result => {
    console.log('R√©sultat API:', result);
    if (result.success) {
      const message = isEdit ? '√ânergie modifi√©e avec succ√®s' : '√ânergie cr√©√©e avec succ√®s';
      showNotification(message, 'success');
      
      // Si c'est une nouvelle √©nergie et que des facteurs ont √©t√© configur√©s, les sauvegarder
      if (!isEdit && currentEnergieForFacteurs === 'new' && window.facteursConfigures) {
        console.log('üîÑ Sauvegarde des facteurs configur√©s apr√®s cr√©ation...');
        
        // R√©cup√©rer l'ID de la nouvelle √©nergie depuis la r√©ponse
        const nouvelleEnergieId = result.energie_id || result.id;
        if (nouvelleEnergieId) {
          console.log('üéØ ID de la nouvelle √©nergie:', nouvelleEnergieId);
          
          // Sauvegarder les facteurs
          sauvegarderFacteursApresCreation(nouvelleEnergieId);
        } else {
          console.warn('‚ö†Ô∏è ID de la nouvelle √©nergie non trouv√© dans la r√©ponse');
          console.warn('üì• R√©ponse compl√®te:', result);
          closeEnergieModal();
          loadEnergies();
        }
      } else {
        console.log('‚ÑπÔ∏è Fermeture directe - pas de facteurs √† sauvegarder');
        console.log('üîç √âtat des facteurs:', {
          isEdit,
          currentEnergieForFacteurs,
          facteursConfigures: window.facteursConfigures
        });
        closeEnergieModal();
        loadEnergies(); // Recharger pour afficher les modifications
      }
    } else {
      showNotification(`Erreur: ${result.error}`, 'error');
    }
  })
  .catch(error => {
    console.error('Erreur lors de la sauvegarde:', error);
    showNotification(`Erreur lors de la sauvegarde: ${error.message}`, 'error');
  });
});

// Gestionnaire de soumission du formulaire des facteurs
document.getElementById('facteurs-form').addEventListener('submit', function(e) {
  e.preventDefault();
  
  console.log('=== SOUMISSION FORMULAIRE FACTEURS ===');
  console.log('üîç √âtat actuel:', {
    currentEnergieForFacteurs,
    energies: energies.length,
    currentEditId
  });
  
  // V√©rifier que currentEnergieForFacteurs est valide
  if (!currentEnergieForFacteurs) {
    console.error('‚ùå Aucune √©nergie s√©lectionn√©e');
    showNotification('Erreur: Aucune √©nergie s√©lectionn√©e.', 'error');
    return;
  }
  
  // Si c'est une nouvelle √©nergie, permettre la configuration des facteurs
  if (currentEnergieForFacteurs === 'new') {
    console.log('‚ÑπÔ∏è Nouvelle √©nergie - facteurs configur√©s mais non sauvegard√©s');
    showNotification('‚úÖ Configuration des facteurs enregistr√©e. Les facteurs seront sauvegard√©s lors de la cr√©ation de l\'√©nergie.', 'success');
    closeFacteursModal();
    return;
  }
  
  // V√©rifier que c'est un ID num√©rique valide
  const energieId = parseInt(currentEnergieForFacteurs);
  console.log('üî¢ ID d\'√©nergie √† traiter:', energieId, 'Type:', typeof energieId);
  
  if (isNaN(energieId) || energieId <= 0) {
    console.error('‚ùå ID d\'√©nergie invalide:', currentEnergieForFacteurs);
    showNotification('Erreur: ID d\'√©nergie invalide. Veuillez d\'abord sauvegarder l\'√©nergie.', 'error');
    return;
  }
  
  // V√©rifier que l'√©nergie existe bien
  const energie = energies.find(e => e.id === energieId);
  console.log('üîç √ânergie trouv√©e:', energie);
  
  if (!energie) {
    console.error('‚ùå √ânergie non trouv√©e pour l\'ID:', energieId);
    console.error('√ânergies disponibles:', energies);
    showNotification('Erreur: √ânergie non trouv√©e. Veuillez d\'abord sauvegarder l\'√©nergie.', 'error');
    return;
  }
  
  // R√©cup√©rer les valeurs directement depuis les champs du formulaire
  const phaseAmont = Math.round((parseFloat(document.getElementById('facteur-phase-amont').value) || 0) * 1000) / 1000;
  const phaseFonctionnement = Math.round((parseFloat(document.getElementById('facteur-phase-fonctionnement').value) || 0) * 1000) / 1000;
  
  // V√©rifier que les deux phases sont renseign√©es
  if (phaseAmont === 0 && phaseFonctionnement === 0) {
    showNotification('‚ùå Erreur: Vous devez renseigner au moins une des deux phases (amont ou fonctionnement)', 'error');
    return;
  }
  
  const total = Math.round((phaseAmont + phaseFonctionnement) * 1000) / 1000;
  
  console.log('üìä Valeurs du formulaire:');
  console.log('- Phase amont:', phaseAmont);
  console.log('- Phase fonctionnement:', phaseFonctionnement);
  console.log('- Total calcul√©:', total);
  
  // R√©cup√©rer les donn√©es suppl√©mentaires de l'√©nergie trouv√©e
  const donnees_supplementaires = energie.donnees_supplementaires || {};
  
  const facteursData = {
    phase_amont: phaseAmont,
    phase_fonctionnement: phaseFonctionnement,
    total: total,
    donnees_supplementaires: donnees_supplementaires
  };
  
  console.log('üì§ Donn√©es √† envoyer √† l\'API:', facteursData);
  console.log('üåê URL de l\'API:', `/api/energies/${energieId}/facteurs`);
  
  // Sauvegarder via l'API
  fetch(`/api/energies/${energieId}/facteurs`, {
    method: 'PUT',
    headers: {
      'Content-Type': 'application/json',
    },
    body: JSON.stringify(facteursData)
  })
  .then(response => {
    console.log('üì° R√©ponse HTTP:', response.status, response.statusText);
    console.log('üì° Headers de r√©ponse:', response.headers);
    
    if (!response.ok) {
      throw new Error(`HTTP ${response.status}: ${response.statusText}`);
    }
    return response.json();
  })
  .then(result => {
    console.log('üì• R√©sultat API:', result);
    
    if (result.success) {
      console.log('‚úÖ Facteurs sauvegard√©s avec succ√®s');
      
      // Mettre √† jour automatiquement le facteur global dans le formulaire principal
      if (total > 0) {
        document.getElementById('energie-facteur').value = total.toFixed(3);
        console.log('‚úÖ Facteur global mis √† jour automatiquement:', total);
      }
      
      // Mettre √† jour la liste des √©nergies en m√©moire
      if (energie) {
        energie.phase_amont = facteursData.phase_amont;
        energie.phase_fonctionnement = facteursData.phase_fonctionnement;
        energie.total = total;
        energie.facteur = total;
        console.log('‚úÖ Donn√©es mises √† jour en m√©moire:', energie);
        
        // Mettre √† jour imm√©diatement l'affichage de cette √©nergie
        updateEnergieDisplay(energie.id);
      }
      
      closeFacteursModal();
      
      // Rafra√Æchissement imm√©diat et rechargement depuis le serveur
      console.log('üîÑ Rafra√Æchissement imm√©diat et rechargement...');
      if (energie) {
        refreshEnergieImmediately(energie.id);
      } else {
        setTimeout(() => {
          loadEnergies();
        }, 300);
      }
      
      showNotification('‚úÖ Facteurs d\'√©mission sauvegard√©s avec succ√®s', 'success');
    } else {
      console.error('‚ùå Erreur API:', result.error);
      showNotification(`Erreur: ${result.error}`, 'error');
    }
  })
  .catch(error => {
    console.error('‚ùå Erreur lors de la sauvegarde:', error);
    console.error('‚ùå Type d\'erreur:', error.name);
    console.error('‚ùå Message d\'erreur:', error.message);
    showNotification(`Erreur lors de la sauvegarde: ${error.message}`, 'error');
  });
});

// Fonction pour mettre √† jour l'affichage d'une √©nergie sp√©cifique
function updateEnergieDisplay(energieId) {
  console.log(`üîÑ Mise √† jour de l'affichage pour l'√©nergie ${energieId}`);
  
  // Trouver l'√©nergie dans la liste
  const energie = energies.find(e => e.id === energieId);
  if (!energie) {
    console.warn(`‚ö†Ô∏è √ânergie ${energieId} non trouv√©e pour la mise √† jour d'affichage`);
    return;
  }
  
  // Trouver le bloc HTML de cette √©nergie
  const energieBlock = document.querySelector(`[data-energie-id="${energieId}"]`);
  if (!energieBlock) {
    console.warn(`‚ö†Ô∏è Bloc HTML pour l'√©nergie ${energieId} non trouv√©`);
    return;
  }
  
  // Calculer le total des √©missions
  const total = (energie.phase_amont || 0) + (energie.phase_fonctionnement || 0) || energie.facteur || 0;
  
  // Mettre √† jour la valeur du total des √©missions
  const totalEmissionsElement = energieBlock.querySelector('.total-emissions-value');
  if (totalEmissionsElement) {
    const unite = energie.unite || 'unit√©';
    totalEmissionsElement.textContent = `${total.toFixed(3)} kg √©q. CO‚ÇÇ/${unite}`;
    console.log(`‚úÖ Total des √©missions mis √† jour: ${total.toFixed(3)} kg √©q. CO‚ÇÇ/${unite}`);
  }
  
  console.log(`‚úÖ Affichage de l'√©nergie ${energieId} mis √† jour avec succ√®s`);
}

// Fonction de rafra√Æchissement imm√©diat pour une √©nergie sp√©cifique
function refreshEnergieImmediately(energieId) {
  console.log(`üöÄ Rafra√Æchissement imm√©diat de l'√©nergie ${energieId}`);
  
  // Mettre √† jour l'affichage local
  updateEnergieDisplay(energieId);
  
  // Recharger depuis le serveur apr√®s un court d√©lai
  setTimeout(() => {
    console.log(`üîÑ Rechargement depuis le serveur pour l'√©nergie ${energieId}`);
    loadEnergies();
  }, 200);
}

// Fonction pour sauvegarder les facteurs apr√®s cr√©ation d'une √©nergie
function sauvegarderFacteursApresCreation(energieId) {
  console.log(`üíæ Sauvegarde des facteurs pour la nouvelle √©nergie ${energieId}`);
  
  // R√©cup√©rer les valeurs depuis le modal des facteurs
  const phaseAmont = parseFloat(document.getElementById('facteur-phase-amont').value) || 0;
  const phaseFonctionnement = parseFloat(document.getElementById('facteur-phase-fonctionnement').value) || 0;
  const total = phaseAmont + phaseFonctionnement;
  
  console.log('üìä Facteurs √† sauvegarder:');
  console.log('- Phase amont:', phaseAmont);
  console.log('- Phase fonctionnement:', phaseFonctionnement);
  console.log('- Total calcul√©:', total);
  
  if (total === 0) {
    console.log('‚ÑπÔ∏è Aucun facteur configur√© - fermeture directe');
    closeEnergieModal();
    loadEnergies();
    return;
  }
  
  const facteursData = {
    phase_amont: phaseAmont,
    phase_fonctionnement: phaseFonctionnement,
    total: total,
    donnees_supplementaires: {}
  };
  
  console.log('üì§ Sauvegarde des facteurs via API...');
  
  // Sauvegarder les facteurs via l'API
  fetch(`/api/energies/${energieId}/facteurs`, {
    method: 'PUT',
    headers: {
      'Content-Type': 'application/json',
    },
    body: JSON.stringify(facteursData)
  })
  .then(response => {
    console.log('üì° R√©ponse API facteurs:', response.status, response.statusText);
    
    if (!response.ok) {
      throw new Error(`HTTP ${response.status}: ${response.statusText}`);
    }
    return response.json();
  })
  .then(result => {
    console.log('üì• R√©sultat API facteurs:', result);
    
    if (result.success) {
      console.log('‚úÖ Facteurs sauvegard√©s avec succ√®s apr√®s cr√©ation');
      showNotification('‚úÖ √ânergie et facteurs cr√©√©s avec succ√®s', 'success');
      
      // Fermer le modal et recharger
      closeEnergieModal();
      loadEnergies();
      
      // R√©initialiser le flag des facteurs configur√©s
      window.facteursConfigures = false;
    } else {
      console.error('‚ùå Erreur lors de la sauvegarde des facteurs:', result.error);
      showNotification('‚ö†Ô∏è √ânergie cr√©√©e mais facteurs non sauvegard√©s', 'warning');
      closeEnergieModal();
      loadEnergies();
    }
  })
  .catch(error => {
    console.error('‚ùå Erreur lors de la sauvegarde des facteurs:', error);
    showNotification('‚ö†Ô∏è √ânergie cr√©√©e mais facteurs non sauvegard√©s', 'warning');
    closeEnergieModal();
    loadEnergies();
  });
}

// Fonction de notification
function showNotification(message, type) {
  // Impl√©mentation simple de notification
  alert(`${type.toUpperCase()}: ${message}`);
}
</script>

<!-- Styles CSS -->
<style>
.energies-container {
  max-width: 1200px;
  margin: 0 auto;
  padding: 20px;
}

.page-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 30px;
  padding: 20px;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  border-radius: 15px;
  color: white;
}

.header-content h1 {
  margin: 0;
  font-size: 2rem;
  font-weight: 600;
}

.header-subtitle {
  margin: 5px 0 0 0;
  opacity: 0.9;
}

.btn-primary {
  background: rgba(255, 255, 255, 0.2);
  color: white;
  border: 2px solid rgba(255, 255, 255, 0.3);
  padding: 12px 24px;
  border-radius: 8px;
  font-size: 1rem;
  cursor: pointer;
  transition: all 0.3s ease;
}

.btn-primary:hover {
  background: rgba(255, 255, 255, 0.3);
  border-color: rgba(255, 255, 255, 0.5);
}

.filters-section {
  display: flex;
  gap: 20px;
  margin-bottom: 30px;
  padding: 20px;
  background: #f8fafc;
  border-radius: 12px;
  border: 1px solid #e2e8f0;
}

.search-box {
  position: relative;
  flex: 1;
}

.search-box input {
  width: 100%;
  padding: 12px 40px 12px 16px;
  border: 2px solid #e2e8f0;
  border-radius: 8px;
  font-size: 1rem;
  transition: all 0.3s ease;
}

.search-box input:focus {
  outline: none;
  border-color: #667eea;
  box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
}

.search-icon {
  position: absolute;
  right: 12px;
  top: 50%;
  transform: translateY(-50%);
  color: #6b7280;
}

.energies-list {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
  gap: 15px;
}

.energie-card {
  background: white;
  border-radius: 10px;
  padding: 15px;
  border: 1px solid #e2e8f0;
  transition: all 0.3s ease;
  min-height: 180px; /* R√©duire la hauteur minimale */
  display: flex;
  flex-direction: column;
}

.energie-card:hover {
  border-color: #667eea;
  box-shadow: 0 8px 25px rgba(102, 126, 234, 0.15);
  transform: translateY(-2px);
}

.energie-header {
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  margin-bottom: 12px;
}

.energie-info h3 {
  margin: 0 0 3px 0;
  font-size: 1.1rem;
  color: #1f2937;
  line-height: 1.2;
}

.energie-id {
  font-size: 0.8rem;
  color: #6b7280;
  font-family: monospace;
}

.energie-badge {
  display: flex;
  gap: 8px;
}

.badge-unit {
  padding: 4px 8px;
  background: #dbeafe;
  color: #1e40af;
  border-radius: 12px;
  font-size: 0.7rem;
  font-weight: 600;
}

.energie-details {
  margin-bottom: 15px;
  flex: 1; /* Prendre l'espace disponible pour centrer le contenu */
}

.detail-row {
  display: flex;
  justify-content: space-between;
  padding: 6px 0;
  border-bottom: 1px solid #f3f4f6;
}

.detail-row:last-child {
  border-bottom: none;
}

.detail-label {
  font-weight: 600;
  color: #4b5563;
  font-size: 0.9rem;
}

.detail-value {
  color: #1f2937;
  font-size: 0.9rem;
}

.total-emissions {
  background: #f0f9ff;
  border-radius: 6px;
  padding: 8px;
  margin: 8px 0;
  border-left: 3px solid #3b82f6;
}

.total-emissions-value {
  font-weight: 700;
  color: #1e40af;
  font-size: 1rem;
}

.energie-actions {
  display: flex;
  gap: 8px;
  flex-wrap: wrap;
}

.btn-edit, .btn-delete {
  flex: 1;
  min-width: 100px;
  padding: 8px 12px;
  border: none;
  border-radius: 6px;
  font-size: 0.85rem;
  cursor: pointer;
  transition: all 0.3s ease;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 6px;
}



.btn-facteurs-inline {
  background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
  color: white;
  border: none;
  padding: 12px 20px;
  border-radius: 8px;
  font-size: 0.9rem;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s ease;
  display: flex;
  align-items: center;
  gap: 8px;
  width: 100%;
  justify-content: center;
}

.btn-facteurs-inline:hover {
  background: linear-gradient(135deg, #7c3aed 0%, #6d28d9 100%);
  transform: translateY(-1px);
  box-shadow: 0 4px 15px rgba(139, 92, 246, 0.3);
}

.btn-edit {
  background: #3b82f6;
  color: white;
}

.btn-edit:hover {
  background: #2563eb;
  transform: translateY(-1px);
}

.btn-delete {
  background: #ef4444;
  color: white;
}

.btn-delete:hover {
  background: #dc2626;
  transform: translateY(-1px);
}

/* Modal styles */
.modal {
  display: none;
  position: fixed;
  z-index: 1000;
  left: 0;
  top: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0, 0, 0, 0.5);
}

.modal-content {
  background-color: white;
  margin: 3% auto;
  padding: 0;
  border-radius: 15px;
  width: 92%;
  max-width: 850px;
  max-height: 92vh;
  overflow-y: auto;
  box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
}

.modal-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 20px 30px;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  border-radius: 15px 15px 0 0;
}

.modal-header h2 {
  margin: 0;
  font-size: 1.3rem;
}

.close-btn {
  background: none;
  border: none;
  color: white;
  font-size: 2rem;
  cursor: pointer;
  padding: 0;
  width: 30px;
  height: 30px;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 50%;
  transition: background-color 0.3s ease;
}

.close-btn:hover {
  background-color: rgba(255, 255, 255, 0.2);
}

.energie-form, .facteurs-form {
  padding: 25px;
}

.facteurs-content {
  padding: 25px;
}

.energie-info {
  text-align: center;
  margin-bottom: 20px;
  padding: 15px;
  background: #f8fafc;
  border-radius: 12px;
  border: 1px solid #e2e8f0;
}

.energie-info h3 {
  margin: 0 0 8px 0;
  color: #1f2937;
  font-size: 1.3rem;
}

.energie-info p {
  margin: 0;
  color: #6b7280;
  font-size: 1rem;
}

.form-row {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 15px;
  margin-bottom: 15px;
}

.form-group {
  display: flex;
  flex-direction: column;
}

.form-group label {
  font-size: 0.85rem;
  font-weight: 600;
  color: #2d3748;
  margin-bottom: 6px;
}

.form-group input,
.form-group select,
.form-group textarea {
  padding: 10px;
  border: 2px solid #e2e8f0;
  border-radius: 8px;
  font-size: 0.95rem;
  transition: all 0.3s ease;
}

.form-group input:focus,
.form-group select:focus,
.form-group textarea:focus {
  outline: none;
  border-color: #667eea;
  box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
}

.form-group input[readonly] {
  background-color: #f7fafc;
  color: #4a5568;
  cursor: not-allowed;
}

.form-help {
  font-size: 0.8rem;
  color: #718096;
  margin-top: 5px;
  font-style: italic;
}

.form-actions {
  display: flex;
  gap: 12px;
  justify-content: flex-end;
  margin-top: 25px;
  padding-top: 15px;
  border-top: 1px solid #e2e8f0;
}

.btn-save, .btn-cancel {
  padding: 10px 20px;
  border: none;
  border-radius: 8px;
  font-size: 0.95rem;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s ease;
}

.btn-save {
  background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
  color: white;
  box-shadow: 0 4px 15px rgba(72, 187, 120, 0.3);
}

.btn-save:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 20px rgba(72, 187, 120, 0.4);
}

.btn-cancel {
  background: linear-gradient(135deg, #f56565 0%, #e53e3e 100%);
  color: white;
  box-shadow: 0 4px 15px rgba(245, 101, 101, 0.3);
}

.btn-cancel:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 20px rgba(245, 101, 101, 0.4);
}

.no-energies {
  text-align: center;
  padding: 60px 20px;
  color: #6b7280;
  font-style: italic;
  background: #f9fafb;
  border-radius: 12px;
  border: 2px dashed #d1d5db;
  grid-column: 1 / -1;
}

/* Styles pour les nouvelles sections */
.section-title {
  margin: 30px 0 20px 0;
  padding: 20px;
  background: #f8fafc;
  border-radius: 12px;
  border-left: 4px solid #667eea;
}

.section-title h4 {
  margin: 0 0 10px 0;
  color: #1f2937;
  font-size: 1.2rem;
}

.section-title p {
  margin: 0;
  color: #6b7280;
  font-size: 0.9rem;
}

.add-value-section {
  text-align: center;
  margin: 20px 0;
}

.btn-add-value {
  background: linear-gradient(135deg, #10b981 0%, #059669 100%);
  color: white;
  border: none;
  padding: 15px 30px;
  border-radius: 8px;
  font-size: 1rem;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s ease;
  display: inline-flex;
  align-items: center;
  gap: 10px;
  box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3);
}

.btn-add-value:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 20px rgba(16, 185, 129, 0.4);
}

.add-value-form {
  background: #f8fafc;
  border: 2px solid #e2e8f0;
  border-radius: 12px;
  padding: 20px;
  margin: 20px 0;
}

.add-value-form h5 {
  margin: 0 0 20px 0;
  color: #1f2937;
  font-size: 1.1rem;
}

.form-actions-inline {
  display: flex;
  gap: 15px;
  justify-content: flex-end;
  margin-top: 20px;
}

.values-list-section {
  margin: 30px 0;
}

.values-list-section h5 {
  margin: 0 0 20px 0;
  color: #1f2937;
  font-size: 1.1rem;
}

.values-list {
  display: flex;
  flex-direction: column;
  gap: 15px;
}

.value-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 15px;
  background: white;
  border: 2px solid #e2e8f0;
  border-radius: 8px;
  transition: all 0.3s ease;
}

.value-item:hover {
  border-color: #667eea;
  box-shadow: 0 2px 8px rgba(102, 126, 234, 0.1);
}

.value-info {
  flex: 1;
}

.value-name {
  font-weight: 600;
  color: #1f2937;
  margin-bottom: 5px;
}

.value-details {
  display: flex;
  gap: 15px;
  align-items: center;
}

.value-valeur {
  font-weight: 500;
  color: #059669;
  background: #d1fae5;
  padding: 4px 8px;
  border-radius: 4px;
  font-size: 0.9rem;
}

.value-description {
  color: #6b7280;
  font-size: 0.9rem;
  font-style: italic;
}

.value-actions {
  display: flex;
  gap: 8px;
}

.btn-edit-small, .btn-delete-small {
  background: none;
  border: none;
  font-size: 1.2rem;
  cursor: pointer;
  padding: 8px;
  border-radius: 4px;
  transition: all 0.3s ease;
}

.btn-edit-small:hover {
  background: #dbeafe;
  color: #1e40af;
}

.btn-delete-small:hover {
  background: #fee2e2;
  color: #dc2626;
}

.no-values {
  text-align: center;
  padding: 40px 20px;
  color: #6b7280;
  font-style: italic;
  background: #f9fafb;
  border-radius: 8px;
  border: 2px dashed #d1d5db;
}

/* Styles pour le modal des facteurs compact */
.facteurs-modal-content {
  max-width: 1000px;
  max-height: 85vh;
}

.energie-info-compact {
  text-align: center;
  margin-bottom: 15px;
  padding: 12px;
  background: #f8fafc;
  border-radius: 8px;
  border: 1px solid #e2e8f0;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 15px;
}

.energie-info-compact h3 {
  margin: 0;
  color: #1f2937;
  font-size: 1.2rem;
}

.energie-unite-badge {
  padding: 4px 12px;
  background: #dbeafe;
  color: #1e40af;
  border-radius: 20px;
  font-size: 0.9rem;
  font-weight: 600;
}

.facteurs-layout {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 25px;
  margin-bottom: 20px;
}

.facteurs-column {
  background: #f8fafc;
  border-radius: 8px;
  padding: 15px;
  border: 1px solid #e2e8f0;
}

.section-title-compact {
  margin: 0 0 15px 0;
  padding: 10px;
  background: white;
  border-radius: 6px;
  border-left: 3px solid #667eea;
}

.section-title-compact h4 {
  margin: 0 0 5px 0;
  color: #1f2937;
  font-size: 1rem;
}

.section-title-compact p {
  margin: 0;
  color: #6b7280;
  font-size: 0.8rem;
}

.facteurs-form-compact {
  display: flex;
  flex-direction: column;
  gap: 12px;
}

.form-group-compact {
  display: flex;
  flex-direction: column;
  gap: 4px;
}

.form-group-compact label {
  font-size: 0.8rem;
  font-weight: 600;
  color: #2d3748;
}

.form-group-compact input {
  padding: 8px 10px;
  border: 2px solid #e2e8f0;
  border-radius: 6px;
  font-size: 0.9rem;
  transition: all 0.3s ease;
}

.form-group-compact input:focus {
  outline: none;
  border-color: #667eea;
  box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.1);
}

.form-group-compact input[readonly] {
  background-color: #f7fafc;
  color: #4a5568;
  cursor: not-allowed;
}

.form-help-compact {
  font-size: 0.75rem;
  color: #718096;
  font-style: italic;
}

.total-group {
  background: #f0f9ff;
  border-radius: 6px;
  padding: 10px;
  border-left: 3px solid #3b82f6;
}

.total-group input {
  font-weight: 600;
  color: #1e40af;
}

.add-value-section-compact {
  text-align: center;
  margin: 15px 0;
}

.btn-add-value-compact {
  background: linear-gradient(135deg, #10b981 0%, #059669 100%);
  color: white;
  border: none;
  padding: 10px 20px;
  border-radius: 6px;
  font-size: 0.9rem;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s ease;
  display: inline-flex;
  align-items: center;
  gap: 8px;
  box-shadow: 0 2px 8px rgba(16, 185, 129, 0.3);
}

.btn-add-value-compact:hover {
  transform: translateY(-1px);
  box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);
}

.add-value-form-compact {
  background: white;
  border: 2px solid #e2e8f0;
  border-radius: 8px;
  padding: 15px;
  margin: 15px 0;
}

.add-value-form-compact h5 {
  margin: 0 0 15px 0;
  color: #1f2937;
  font-size: 1rem;
}

.form-actions-inline-compact {
  display: flex;
  gap: 10px;
  justify-content: flex-end;
  margin-top: 15px;
}

.btn-save-compact, .btn-cancel-compact {
  padding: 8px 16px;
  border: none;
  border-radius: 6px;
  font-size: 0.85rem;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s ease;
}

.btn-save-compact {
  background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
  color: white;
}

.btn-cancel-compact {
  background: linear-gradient(135deg, #f56565 0%, #e53e3e 100%);
  color: white;
}

.values-list-section-compact {
  margin: 15px 0;
}

.values-list-section-compact h5 {
  margin: 0 0 15px 0;
  color: #1f2937;
  font-size: 1rem;
}

.values-list-compact {
  display: flex;
  flex-direction: column;
  gap: 10px;
  max-height: 200px;
  overflow-y: auto;
}

.value-item-compact {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 10px;
  background: white;
  border: 1px solid #e2e8f0;
  border-radius: 6px;
  transition: all 0.3s ease;
}

.value-item-compact:hover {
  border-color: #667eea;
  box-shadow: 0 2px 6px rgba(102, 126, 234, 0.1);
}

.value-info-compact {
  flex: 1;
}

.value-name-compact {
  font-weight: 600;
  color: #1f2937;
  font-size: 0.9rem;
  margin-bottom: 3px;
}

.value-details-compact {
  display: flex;
  gap: 10px;
  align-items: center;
  font-size: 0.8rem;
}

.value-valeur-compact {
  font-weight: 500;
  color: #059669;
  background: #d1fae5;
  padding: 2px 6px;
  border-radius: 3px;
}

.value-description-compact {
  color: #6b7280;
  font-style: italic;
}

.value-actions-compact {
  display: flex;
  gap: 5px;
}

.btn-edit-small-compact, .btn-delete-small-compact {
  background: none;
  border: none;
  font-size: 1rem;
  cursor: pointer;
  padding: 5px;
  border-radius: 3px;
  transition: all 0.3s ease;
}

.btn-edit-small-compact:hover {
  background: #dbeafe;
  color: #1e40af;
}

.btn-delete-small-compact:hover {
  background: #fee2e2;
  color: #dc2626;
}

.form-actions-compact {
  display: flex;
  gap: 12px;
  justify-content: flex-end;
  margin-top: 20px;
  padding-top: 15px;
  border-top: 1px solid #e2e8f0;
}

/* Responsive design */
@media (max-width: 768px) {
  .page-header {
    flex-direction: column;
    gap: 20px;
    text-align: center;
  }
  
  .energies-list {
    grid-template-columns: 1fr;
    gap: 12px;
  }
  
  .energie-card {
    min-height: 160px;
    padding: 12px;
  }
  
  .form-row {
    grid-template-columns: 1fr;
  }
  
  .modal-content {
    width: 95%;
    margin: 2% auto;
  }
  
  .energie-form, .facteurs-form, .facteurs-content {
    padding: 20px;
  }
  
  .energie-actions {
    flex-direction: column;
    gap: 6px;
  }
  
  .btn-edit, .btn-delete {
    min-width: auto;
    padding: 10px 16px;
    font-size: 0.9rem;
  }
  
  .value-item {
    flex-direction: column;
    align-items: flex-start;
    gap: 15px;
  }
  
  .value-details {
    flex-direction: column;
    align-items: flex-start;
    gap: 8px;
  }
  
  .value-actions {
    align-self: flex-end;
  }
  
  /* Responsive pour le modal des facteurs */
  .facteurs-layout {
    grid-template-columns: 1fr;
    gap: 15px;
  }
  
  .facteurs-modal-content {
    max-width: 95%;
    max-height: 90vh;
  }
  
  .energie-info-compact {
    flex-direction: column;
    gap: 10px;
  }
}

/* Responsive pour les √©crans moyens */
@media (max-width: 1024px) and (min-width: 769px) {
  .energies-list {
    grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
    gap: 12px;
  }
  
  .energie-card {
    min-height: 170px;
    padding: 12px;
  }
}
</style>
{% endblock %}
