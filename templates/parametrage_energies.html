{% extends "base.html" %}
{% block title %}Gestion des √ânergies ‚Äî GreenXploit{% endblock %}

{% block content %}
<div class="energies-container">
  <!-- Header -->
  <div class="page-header">
    <div class="header-content">
      <h1>‚ö° Gestion des √ânergies</h1>
      <p class="header-subtitle">G√©rez les sources d'√©nergie et leurs facteurs d'√©mission CO‚ÇÇ</p>
    </div>
    <div class="header-actions">
      <button class="btn-primary" onclick="showAddEnergieModal()">
        <span class="btn-icon">‚ûï</span>
        Ajouter une √ânergie
      </button>
    </div>
  </div>

  <!-- Filtres et recherche -->
  <div class="filters-section">
    <div class="search-box">
      <input type="text" id="search-energies" placeholder="Rechercher une √©nergie..." onkeyup="filterEnergies()">
      <span class="search-icon">üîç</span>
    </div>
  </div>

  <!-- Liste des √©nergies -->
  <div class="energies-list" id="energies-list">
    <!-- Les √©nergies seront charg√©es dynamiquement -->
  </div>

  <!-- Modal d'ajout/modification d'√©nergie -->
  <div id="energie-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 id="energie-modal-title">Ajouter une √ânergie</h2>
        <button class="close-btn" onclick="closeEnergieModal()">&times;</button>
      </div>
      
      <form id="energie-form" class="energie-form">
        <div class="form-row">
          <div class="form-group">
            <label for="energie-id">Identifiant *</label>
            <input type="text" id="energie-id" name="id" required placeholder="Ex: GAZOLE">
          </div>
          <div class="form-group">
            <label for="energie-nom">Nom *</label>
            <input type="text" id="energie-nom" name="nom" required placeholder="Ex: Gazole routier">
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label for="energie-unite">Unit√© de mesure *</label>
            <select id="energie-unite" name="unite" required>
              <option value="">S√©lectionner l'unit√©</option>
              <option value="L">Litre (L)</option>
              <option value="kg">Kilogramme (kg)</option>
              <option value="kwh">Kilowatt-heure (kWh)</option>
            </select>
          </div>
          <div class="form-group">
            <label for="energie-facteur">Facteur d'√©mission global (kg √©q. CO‚ÇÇ/unit√©)</label>
            <input type="number" id="energie-facteur" name="facteur" step="0.001" min="0" placeholder="0.000">
            <small class="form-help">Optionnel - Entrez une valeur ou configurez les facteurs d√©taill√©s ci-dessous</small>
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label for="energie-explication">Explication</label>
            <textarea id="energie-explication" name="explication" rows="3" placeholder="Description de l'√©nergie et de son facteur d'√©mission..."></textarea>
          </div>
        </div>

                 <div class="form-row">
           <div class="form-group">
             <label for="energie-lien-source">Lien source</label>
             <input type="url" id="energie-lien-source" name="lien_source" placeholder="https://...">
           </div>
         </div>
 
         <div class="form-row">
           <div class="form-group">
             <button type="button" class="btn-facteurs-inline" onclick="showFacteursModalFromEnergieForm()">
               <span class="btn-icon">üìä</span>
               Configurer les Facteurs d'√âmission
             </button>
             <small class="form-help">Configurez les √©missions d√©taill√©es (phase amont, phase fonctionnement) - Optionnel pour la cr√©ation</small>
           </div>
         </div>
 
         <div class="form-actions">
           <button type="submit" class="btn-save">üíæ Sauvegarder</button>
           <button type="button" class="btn-cancel" onclick="closeEnergieModal()">‚ùå Annuler</button>
         </div>
      </form>
    </div>
  </div>

  <!-- Modal des facteurs d'√©mission d√©taill√©s -->
  <div id="facteurs-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 id="facteurs-modal-title">Configurer les Facteurs d'√âmission</h2>
        <button class="close-btn" onclick="closeFacteursModal()">&times;</button>
      </div>
      
      <div class="facteurs-content">
        <div class="energie-info">
          <h3 id="energie-nom-facteurs"></h3>
          <p id="energie-unite-facteurs"></p>
        </div>

        <!-- Section 1: Valeurs de calcul (Phase amont, Phase fonctionnement) -->
        <div class="section-title">
          <h4>üìä Valeurs de Calcul</h4>
          <p>Ces valeurs sont utilis√©es pour le calcul automatique des √©missions de transport</p>
        </div>

        <form id="facteurs-form" class="facteurs-form">
          <div class="form-row">
            <div class="form-group">
              <label for="facteur-phase-amont">Phase amont (kg √©q. CO‚ÇÇ/unit√©) *</label>
              <input type="number" id="facteur-phase-amont" name="phase_amont" required step="0.001" min="0" placeholder="Ex: 0.66">
              <small class="form-help">√âmissions en phase amont par unit√© d'√©nergie</small>
            </div>
            <div class="form-group">
              <label for="facteur-phase-fonctionnement">Phase de fonctionnement (kg √©q. CO‚ÇÇ/unit√©) *</label>
              <input type="number" id="facteur-phase-fonctionnement" name="phase_fonctionnement" required step="0.001" min="0" placeholder="Ex: 2.51">
              <small class="form-help">√âmissions en phase de fonctionnement par unit√© d'√©nergie</small>
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="facteur-total">Total (kg √©q. CO‚ÇÇ/unit√©)</label>
              <input type="number" id="facteur-total" name="total" step="0.001" min="0" placeholder="Calcul√© automatiquement" readonly>
              <small class="form-help">Total des √©missions (Phase amont + Phase de fonctionnement)</small>
            </div>
          </div>
        </form>

        <!-- Section 2: Valeurs suppl√©mentaires -->
        <div class="section-title">
          <h4>‚ûï Valeurs Suppl√©mentaires</h4>
          <p>Ajoutez des valeurs personnalis√©es pour des calculs sp√©cifiques</p>
        </div>

        <!-- Bouton pour ajouter une nouvelle valeur -->
        <div class="add-value-section">
          <button type="button" class="btn-add-value" onclick="showAddValueForm()">
            <span class="btn-icon">‚ûï</span>
            Ajouter une Valeur
          </button>
        </div>

        <!-- Formulaire d'ajout de valeur (cach√© par d√©faut) -->
        <div id="add-value-form" class="add-value-form" style="display: none;">
          <h5>Nouvelle Valeur</h5>
          <div class="form-row">
            <div class="form-group">
              <label for="new-value-name">Nom de la valeur *</label>
              <input type="text" id="new-value-name" placeholder="Ex: √âmissions indirectes">
            </div>
            <div class="form-group">
              <label for="new-value-valeur">Valeur (kg √©q. CO‚ÇÇ/unit√©) *</label>
              <input type="number" id="new-value-valeur" step="0.001" min="0" placeholder="Ex: 0.85">
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label for="new-value-unite">Unit√©</label>
              <input type="text" id="new-value-unite" value="kg √©q. CO‚ÇÇ" placeholder="kg √©q. CO‚ÇÇ">
            </div>
            <div class="form-group">
              <label for="new-value-description">Description</label>
              <input type="text" id="new-value-description" placeholder="Description de cette valeur">
            </div>
          </div>
          <div class="form-actions-inline">
            <button type="button" class="btn-save" onclick="addNewValue()">üíæ Ajouter</button>
            <button type="button" class="btn-cancel" onclick="hideAddValueForm()">‚ùå Annuler</button>
          </div>
        </div>

        <!-- Liste des valeurs suppl√©mentaires -->
        <div class="values-list-section">
          <h5>Valeurs Configur√©es</h5>
          <div id="values-list" class="values-list">
            <!-- Les valeurs seront charg√©es dynamiquement -->
          </div>
        </div>

        <!-- Actions principales -->
        <div class="form-actions">
          <button type="submit" form="facteurs-form" class="btn-save">üíæ Sauvegarder Tout</button>
          <button type="button" class="btn-cancel" onclick="closeFacteursModal()">‚ùå Annuler</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Scripts JavaScript -->
<script>
let energies = [];
let currentEditId = null;
let currentEnergieForFacteurs = null;

// Charger les √©nergies au d√©marrage
document.addEventListener('DOMContentLoaded', function() {
  loadEnergies();
  
  // Ajouter les √©couteurs d'√©v√©nements pour le calcul automatique du total
document.getElementById('facteur-phase-amont').addEventListener('input', calculateTotalFacteur);
document.getElementById('facteur-phase-fonctionnement').addEventListener('input', calculateTotalFacteur);

// Ajouter la validation personnalis√©e pour √©viter les alertes du navigateur
document.getElementById('facteur-phase-amont').addEventListener('invalid', function(e) {
  e.preventDefault();
  this.setCustomValidity('');
});
document.getElementById('facteur-phase-fonctionnement').addEventListener('invalid', function(e) {
  e.preventDefault();
  this.setCustomValidity('');
});
});

// Calculer automatiquement le total des facteurs d'√©mission
function calculateTotalFacteur() {
  const phaseAmont = parseFloat(document.getElementById('facteur-phase-amont').value) || 0;
  const phaseFonctionnement = parseFloat(document.getElementById('facteur-phase-fonctionnement').value) || 0;
  const total = phaseAmont + phaseFonctionnement;
  
  // Afficher avec 3 d√©cimales pour plus de pr√©cision
  document.getElementById('facteur-total').value = total.toFixed(3);
  
  // Mettre √† jour automatiquement le facteur global dans le modal d'√©nergie
  const facteurGlobalField = document.getElementById('energie-facteur');
  if (facteurGlobalField) {
    facteurGlobalField.value = total.toFixed(3);
  }
}

// Mettre √† jour le facteur global d'une √©nergie apr√®s sauvegarde des facteurs
function updateEnergieFacteur(energieId, nouveauFacteur) {
  const energie = energies.find(e => e.id === energieId);
  if (energie) {
    energie.facteur = nouveauFacteur;
    
    // Mettre √† jour via l'API
    fetch(`/api/energies/${energieId}`, {
      method: 'PUT',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        nom: energie.nom,
        identifiant: energie.identifiant,
        unite: energie.unite,
        facteur: nouveauFacteur,
        description: energie.description
      })
    })
    .then(response => response.json())
    .then(result => {
      if (result.success) {
        console.log('Facteur global mis √† jour avec succ√®s');
        loadEnergies(); // Recharger la liste
      } else {
        console.error('Erreur lors de la mise √† jour du facteur global:', result.error);
      }
    })
    .catch(error => {
      console.error('Erreur lors de la mise √† jour du facteur global:', error);
    });
  }
}

// Charger la liste des √©nergies
function loadEnergies() {
  console.log('Chargement des √©nergies...');
  fetch('/api/energies')
    .then(response => response.json())
    .then(result => {
      console.log('Donn√©es re√ßues de l\'API:', result);
      
      if (result.success && result.energies) {
        // L'API retourne {success: true, energies: [...]}
        energies = result.energies.map(energie => ({
          id: energie.id,
          nom: energie.nom,
          identifiant: energie.identifiant,
          facteur: energie.facteur,
          description: energie.description,
          unite: energie.unite || 'N/A',
          phase_amont: energie.phase_amont || 0,
          phase_fonctionnement: energie.phase_fonctionnement || 0,
          total: energie.total || energie.facteur || 0,
          donnees_supplementaires: energie.donnees_supplementaires || {}
        }));
      } else {
        // Fallback pour l'ancien format
        energies = Object.entries(result).map(([id, data]) => ({ id, ...data }));
      }
      
      console.log('√ânergies format√©es:', energies);
      displayEnergies(energies);
    })
    .catch(error => {
      console.error('Erreur lors du chargement des √©nergies:', error);
      showNotification('Erreur lors du chargement des √©nergies', 'error');
    });
}

// Afficher la liste des √©nergies
function displayEnergies(energiesToShow) {
  const container = document.getElementById('energies-list');
  
  if (energiesToShow.length === 0) {
    container.innerHTML = '<div class="no-energies">Aucune √©nergie trouv√©e</div>';
    return;
  }
  
  container.innerHTML = energiesToShow.map(energie => `
    <div class="energie-card" data-id="${energie.id}">
      <div class="energie-header">
        <div class="energie-info">
          <h3>${energie.nom || 'Sans nom'}</h3>
          <span class="energie-id">${energie.identifiant || energie.id}</span>
        </div>
        <div class="energie-badge">
          <span class="badge-unit">${energie.unite || 'N/A'}</span>
        </div>
      </div>
      
      <div class="energie-details">
        <div class="detail-row">
          <span class="detail-label">Facteur global:</span>
          <span class="detail-value">${energie.facteur || 0} kg √©q. CO‚ÇÇ/unit√©</span>
        </div>
        <div class="detail-row">
          <span class="detail-label">Phase amont:</span>
          <span class="detail-value">${energie.phase_amont || 0} kg √©q. CO‚ÇÇ/unit√©</span>
        </div>
        <div class="detail-row">
          <span class="detail-label">Phase fonctionnement:</span>
          <span class="detail-value">${energie.phase_fonctionnement || 0} kg √©q. CO‚ÇÇ/unit√©</span>
        </div>
        <div class="detail-row">
          <span class="detail-label">Total d√©taill√©:</span>
          <span class="detail-value">${energie.total || energie.facteur || 0} kg √©q. CO‚ÇÇ/unit√©</span>
        </div>
      </div>
      
      <div class="energie-actions">
        <button class="btn-edit" onclick="editEnergie('${energie.id}')">
          <span class="btn-icon">‚úèÔ∏è</span>
          Modifier
        </button>
        <button class="btn-delete" onclick="deleteEnergie('${energie.id}')">
          <span class="btn-icon">üóëÔ∏è</span>
          Supprimer
        </button>
      </div>
    </div>
  `).join('');
}

// Filtrer les √©nergies
function filterEnergies() {
  const searchTerm = document.getElementById('search-energies').value.toLowerCase();
  
  const filtered = energies.filter(energie => {
    return energie.nom.toLowerCase().includes(searchTerm) || 
           energie.id.toLowerCase().includes(searchTerm);
  });
  
  displayEnergies(filtered);
}

// Afficher le modal d'ajout
function showAddEnergieModal() {
  currentEditId = null;
  document.getElementById('energie-modal-title').textContent = 'Ajouter une √ânergie';
  document.getElementById('energie-form').reset();
  document.getElementById('energie-modal').style.display = 'block';
}

// Afficher le modal de modification
function editEnergie(energieId) {
  const energie = energies.find(e => e.id === energieId);
  if (!energie) return;
  
  currentEditId = energieId;
  document.getElementById('energie-modal-title').textContent = `Modifier l'√ânergie ${energie.identifiant || energieId}`;
  
  // Remplir le formulaire
  document.getElementById('energie-id').value = energie.identifiant || energie.id || '';
  document.getElementById('energie-nom').value = energie.nom || '';
  document.getElementById('energie-unite').value = energie.unite || '';
  document.getElementById('energie-facteur').value = energie.facteur || '';
  document.getElementById('energie-explication').value = energie.description || '';
  document.getElementById('energie-lien-source').value = energie.lien_source || '';
  
  document.getElementById('energie-modal').style.display = 'block';
}

// Afficher le modal des facteurs d'√©mission
function showFacteursModal(energieId) {
  const energie = energies.find(e => e.id === energieId);
  if (!energie) return;
  
  // S'assurer que l'ID est num√©rique
  currentEnergieForFacteurs = parseInt(energieId);
  document.getElementById('energie-nom-facteurs').textContent = energie.nom;
  document.getElementById('energie-unite-facteurs').textContent = `Unit√©: ${energie.unite || 'N/A'}`;
  
  // Remplir le formulaire des facteurs
  document.getElementById('facteur-phase-amont').value = energie.phase_amont || '';
  document.getElementById('facteur-phase-fonctionnement').value = energie.phase_fonctionnement || '';
  document.getElementById('facteur-total').value = energie.total || energie.facteur || '';
  
  // Charger et afficher les valeurs suppl√©mentaires
  loadEnergieValues(energieId);
  
  document.getElementById('facteurs-modal').style.display = 'block';
}

// Afficher le modal des facteurs depuis le formulaire d'√©nergie
function showFacteursModalFromEnergieForm() {
  // R√©cup√©rer les donn√©es du formulaire d'√©nergie
  const energieId = document.getElementById('energie-id').value;
  const energieNom = document.getElementById('energie-nom').value;
  const energieUnite = document.getElementById('energie-unite').value;
  
  if (!energieId || !energieNom || !energieUnite) {
    alert('Veuillez d\'abord remplir l\'identifiant, le nom et l\'unit√© de l\'√©nergie');
    return;
  }
  
  // Si c'est une nouvelle √©nergie, utiliser les donn√©es du formulaire
  if (!currentEditId) {
    // Pour une nouvelle √©nergie, on peut configurer les facteurs mais on utilise un ID temporaire
    currentEnergieForFacteurs = 'new'; // Marqueur pour nouvelle √©nergie
    document.getElementById('energie-nom-facteurs').textContent = energieNom;
    document.getElementById('energie-unite-facteurs').textContent = `Unit√©: ${energieUnite}`;
    
    // Vider les champs des facteurs pour une nouvelle √©nergie
    document.getElementById('facteur-phase-amont').value = '';
    document.getElementById('facteur-phase-fonctionnement').value = '';
    document.getElementById('facteur-total').value = '';
    
    // Vider la liste des valeurs suppl√©mentaires pour une nouvelle √©nergie
    displayEnergieValues({});
  } else {
    // Si c'est une modification, utiliser les donn√©es existantes
    const energie = energies.find(e => e.id === energieId || e.identifiant === energieId);
    if (energie) {
      currentEnergieForFacteurs = energie.id; // Utiliser l'ID num√©rique de la base
      document.getElementById('energie-nom-facteurs').textContent = energie.nom;
      document.getElementById('energie-unite-facteurs').textContent = `Unit√©: ${energie.unite || 'N/A'}`;
      
      // Remplir avec les valeurs existantes
      document.getElementById('facteur-phase-amont').value = energie.phase_amont || '';
      document.getElementById('facteur-phase-fonctionnement').value = energie.phase_fonctionnement || '';
      document.getElementById('facteur-total').value = energie.total || energie.facteur || '';
      
      // Mettre √† jour le facteur global avec la valeur existante
      document.getElementById('energie-facteur').value = energie.facteur || '';
      
      // Charger les valeurs suppl√©mentaires existantes
      loadEnergieValues(energie.id);
    } else {
      alert('√ânergie non trouv√©e. Veuillez d\'abord sauvegarder l\'√©nergie.');
      return;
    }
  }
  
  document.getElementById('facteurs-modal').style.display = 'block';
}

// Fermer le modal d'√©nergie
function closeEnergieModal() {
  document.getElementById('energie-modal').style.display = 'none';
  currentEditId = null;
}

// Fermer le modal des facteurs
function closeFacteursModal() {
  // Synchroniser le facteur global avec le total calcul√©
  const total = document.getElementById('facteur-total').value;
  if (total && total !== '0.000') {
    const facteurGlobalField = document.getElementById('energie-facteur');
    if (facteurGlobalField) {
      facteurGlobalField.value = total;
    }
  }
  
  // Cacher le formulaire d'ajout de valeur
  hideAddValueForm();
  
  document.getElementById('facteurs-modal').style.display = 'none';
  currentEnergieForFacteurs = null;
}

// Afficher le formulaire d'ajout de valeur
function showAddValueForm() {
  document.getElementById('add-value-form').style.display = 'block';
  // Vider les champs
  document.getElementById('new-value-name').value = '';
  document.getElementById('new-value-valeur').value = '';
  document.getElementById('new-value-unite').value = 'kg √©q. CO‚ÇÇ';
  document.getElementById('new-value-description').value = '';
}

// Cacher le formulaire d'ajout de valeur
function hideAddValueForm() {
  document.getElementById('add-value-form').style.display = 'none';
}

// Charger les valeurs suppl√©mentaires d'une √©nergie
function loadEnergieValues(energieId) {
  // Pour l'instant, on utilise les donn√©es existantes
  // Plus tard, on pourra appeler l'API pour r√©cup√©rer les valeurs
  const energie = energies.find(e => e.id === energieId);
  if (!energie) return;
  
  // Afficher les valeurs existantes (si disponibles)
  displayEnergieValues(energie.donnees_supplementaires || {});
}

// Afficher les valeurs suppl√©mentaires
function displayEnergieValues(values) {
  const container = document.getElementById('values-list');
  
  if (!values || Object.keys(values).length === 0) {
    container.innerHTML = '<div class="no-values">Aucune valeur suppl√©mentaire configur√©e</div>';
    return;
  }
  
  container.innerHTML = Object.entries(values).map(([name, data]) => `
    <div class="value-item" data-name="${name}">
      <div class="value-info">
        <div class="value-name">${name}</div>
        <div class="value-details">
          <span class="value-valeur">${data.valeur} ${data.unite || 'kg √©q. CO‚ÇÇ'}</span>
          ${data.description ? `<span class="value-description">${data.description}</span>` : ''}
        </div>
      </div>
      <div class="value-actions">
        <button class="btn-edit-small" onclick="editValue('${name}')" title="Modifier">
          ‚úèÔ∏è
        </button>
        <button class="btn-delete-small" onclick="deleteValue('${name}')" title="Supprimer">
          üóëÔ∏è
        </button>
      </div>
    </div>
  `).join('');
}

// Ajouter une nouvelle valeur
function addNewValue() {
  const name = document.getElementById('new-value-name').value.trim();
  const valeur = parseFloat(document.getElementById('new-value-valeur').value);
  const unite = document.getElementById('new-value-unite').value.trim();
  const description = document.getElementById('new-value-description').value.trim();
  
  if (!name || isNaN(valeur)) {
    alert('Veuillez remplir le nom et la valeur');
    return;
  }
  
  const newValue = {
    nom: name,
    valeur: valeur,
    unite: unite || 'kg √©q. CO‚ÇÇ',
    description: description
  };
  
  // Appeler l'API pour ajouter la valeur
  fetch(`/api/energies/${currentEnergieForFacteurs}/donnees`, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
    },
    body: JSON.stringify(newValue)
  })
  .then(response => response.json())
  .then(result => {
    if (result.success) {
      showNotification('Valeur ajout√©e avec succ√®s', 'success');
      hideAddValueForm();
      // Recharger les valeurs
      loadEnergieValues(currentEnergieForFacteurs);
      // Recharger la liste des √©nergies
      loadEnergies();
    } else {
      showNotification(`Erreur: ${result.error}`, 'error');
    }
  })
  .catch(error => {
    console.error('Erreur lors de l\'ajout de la valeur:', error);
    showNotification('Erreur lors de l\'ajout de la valeur', 'error');
  });
}

// Modifier une valeur existante
function editValue(valueName) {
  // Pour l'instant, on utilise un prompt simple
  // Plus tard, on pourra cr√©er un modal d'√©dition
  const newValeur = prompt(`Nouvelle valeur pour "${valueName}" (kg √©q. CO‚ÇÇ):`);
  if (newValeur === null || isNaN(parseFloat(newValeur))) return;
  
  const energie = energies.find(e => e.id === currentEnergieForFacteurs);
  if (!energie || !energie.donnees_supplementaires) return;
  
  // Mettre √† jour la valeur
  energie.donnees_supplementaires[valueName].valeur = parseFloat(newValeur);
  
  // Sauvegarder via l'API des facteurs
  const facteursData = {
    phase_amont: parseFloat(document.getElementById('facteur-phase-amont').value) || 0,
    phase_fonctionnement: parseFloat(document.getElementById('facteur-phase-fonctionnement').value) || 0,
    total: parseFloat(document.getElementById('facteur-total').value) || 0,
    donnees_supplementaires: energie.donnees_supplementaires
  };
  
  fetch(`/api/energies/${currentEnergieForFacteurs}/facteurs`, {
    method: 'PUT',
    headers: {
      'Content-Type': 'application/json',
    },
    body: JSON.stringify(facteursData)
  })
  .then(response => response.json())
  .then(result => {
    if (result.success) {
      showNotification('Valeur modifi√©e avec succ√®s', 'success');
      loadEnergieValues(currentEnergieForFacteurs);
      loadEnergies();
    } else {
      showNotification(`Erreur: ${result.error}`, 'error');
    }
  })
  .catch(error => {
    console.error('Erreur lors de la modification:', error);
    showNotification('Erreur lors de la modification', 'error');
  });
}

// Supprimer une valeur
function deleteValue(valueName) {
  if (!confirm(`√ätes-vous s√ªr de vouloir supprimer la valeur "${valueName}" ?`)) return;
  
  fetch(`/api/energies/${currentEnergieForFacteurs}/donnees/${encodeURIComponent(valueName)}`, {
    method: 'DELETE'
  })
  .then(response => response.json())
  .then(result => {
    if (result.success) {
      showNotification('Valeur supprim√©e avec succ√®s', 'success');
      loadEnergieValues(currentEnergieForFacteurs);
      loadEnergies();
    } else {
      showNotification(`Erreur: ${result.error}`, 'error');
    }
  })
  .catch(error => {
    console.error('Erreur lors de la suppression:', error);
    showNotification('Erreur lors de la suppression', 'error');
  });
}

// Supprimer une √©nergie
function deleteEnergie(energieId) {
  if (confirm(`√ätes-vous s√ªr de vouloir supprimer l'√©nergie ${energieId} ?`)) {
    // Appeler l'API de suppression
    fetch(`/api/energies/${energieId}`, {
      method: 'DELETE',
      headers: {
        'Content-Type': 'application/json',
      }
    })
    .then(response => response.json())
    .then(result => {
      if (result.success) {
        showNotification('√ânergie supprim√©e avec succ√®s', 'success');
        // Recharger la liste des √©nergies
        loadEnergies();
      } else {
        showNotification(`Erreur: ${result.error}`, 'error');
      }
    })
    .catch(error => {
      console.error('Erreur lors de la suppression:', error);
      showNotification('Erreur lors de la suppression', 'error');
    });
  }
}

// Gestionnaire de soumission du formulaire d'√©nergie
document.getElementById('energie-form').addEventListener('submit', function(e) {
  e.preventDefault();
  
  const formData = new FormData(e.target);
  
  // R√©cup√©rer les donn√©es du formulaire
  const energieData = {
    identifiant: formData.get('id'), // L'API attend 'identifiant'
    nom: formData.get('nom'),
    facteur: parseFloat(formData.get('facteur')) || 0,
    description: formData.get('explication'), // L'API attend 'description'
    unite: formData.get('unite')
  };
  
  console.log('Donn√©es √† envoyer √† l\'API:', energieData);
  
  // Sauvegarder l'√©nergie via l'API
  fetch('/api/energies', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
    },
    body: JSON.stringify(energieData) // Envoyer directement les donn√©es
  })
  .then(response => {
    console.log('R√©ponse HTTP:', response.status, response.statusText);
    if (!response.ok) {
      throw new Error(`HTTP ${response.status}: ${response.statusText}`);
    }
    return response.json();
  })
  .then(result => {
    console.log('R√©sultat API:', result);
    if (result.success) {
      showNotification('√ânergie sauvegard√©e avec succ√®s', 'success');
      closeEnergieModal();
      loadEnergies(); // Recharger pour afficher les modifications
    } else {
      showNotification(`Erreur: ${result.error}`, 'error');
    }
  })
  .catch(error => {
    console.error('Erreur lors de la sauvegarde:', error);
    showNotification(`Erreur lors de la sauvegarde: ${error.message}`, 'error');
  });
});

// Gestionnaire de soumission du formulaire des facteurs
document.getElementById('facteurs-form').addEventListener('submit', function(e) {
  e.preventDefault();
  
  const formData = new FormData(e.target);
  
  // V√©rifier que currentEnergieForFacteurs est valide
  if (!currentEnergieForFacteurs) {
    showNotification('Erreur: Aucune √©nergie s√©lectionn√©e.', 'error');
    return;
  }
  
  // Si c'est une nouvelle √©nergie, on ne peut pas sauvegarder les facteurs encore
  if (currentEnergieForFacteurs === 'new') {
    showNotification('Veuillez d\'abord sauvegarder l\'√©nergie avant de configurer ses facteurs.', 'info');
    return;
  }
  
  // V√©rifier que c'est un ID num√©rique
  if (isNaN(parseInt(currentEnergieForFacteurs))) {
    showNotification('Erreur: ID d\'√©nergie invalide. Veuillez d\'abord sauvegarder l\'√©nergie.', 'error');
    return;
  }
  
  // R√©cup√©rer l'√©nergie actuelle pour ses donn√©es suppl√©mentaires
  const energie = energies.find(e => e.id === parseInt(currentEnergieForFacteurs));
  const donnees_supplementaires = energie ? (energie.donnees_supplementaires || {}) : {};
  
  const facteursData = {
    phase_amont: parseFloat(formData.get('phase_amont')) || 0,
    phase_fonctionnement: parseFloat(formData.get('phase_fonctionnement')) || 0,
    total: parseFloat(formData.get('total')) || 0,
    donnees_supplementaires: donnees_supplementaires
  };
  
  console.log('Sauvegarde des facteurs pour l\'√©nergie ID:', currentEnergieForFacteurs);
  console.log('Donn√©es √† sauvegarder:', facteursData);
  
  // Sauvegarder via l'API
  fetch(`/api/energies/${currentEnergieForFacteurs}/facteurs`, {
    method: 'PUT',
    headers: {
      'Content-Type': 'application/json',
    },
    body: JSON.stringify(facteursData)
  })
  .then(response => {
    console.log('R√©ponse API:', response);
    if (!response.ok) {
      throw new Error(`HTTP ${response.status}: ${response.statusText}`);
    }
    return response.json();
  })
  .then(result => {
    console.log('R√©sultat API:', result);
    if (result.success) {
      showNotification('Facteurs d\'√©mission sauvegard√©s avec succ√®s', 'success');
      closeFacteursModal();
      
      // Forcer le rechargement imm√©diat des donn√©es
      console.log('Rechargement forc√© des √©nergies...');
      setTimeout(() => {
        loadEnergies();
      }, 100); // Petit d√©lai pour s'assurer que la sauvegarde est termin√©e
    } else {
      showNotification(`Erreur: ${result.error}`, 'error');
    }
  })
  .catch(error => {
    console.error('Erreur lors de la sauvegarde:', error);
    showNotification(`Erreur lors de la sauvegarde: ${error.message}`, 'error');
  });
});

// Fonction de notification
function showNotification(message, type) {
  // Impl√©mentation simple de notification
  alert(`${type.toUpperCase()}: ${message}`);
}
</script>

<!-- Styles CSS -->
<style>
.energies-container {
  max-width: 1200px;
  margin: 0 auto;
  padding: 20px;
}

.page-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 30px;
  padding: 20px;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  border-radius: 15px;
  color: white;
}

.header-content h1 {
  margin: 0;
  font-size: 2rem;
  font-weight: 600;
}

.header-subtitle {
  margin: 5px 0 0 0;
  opacity: 0.9;
}

.btn-primary {
  background: rgba(255, 255, 255, 0.2);
  color: white;
  border: 2px solid rgba(255, 255, 255, 0.3);
  padding: 12px 24px;
  border-radius: 8px;
  font-size: 1rem;
  cursor: pointer;
  transition: all 0.3s ease;
}

.btn-primary:hover {
  background: rgba(255, 255, 255, 0.3);
  border-color: rgba(255, 255, 255, 0.5);
}

.filters-section {
  display: flex;
  gap: 20px;
  margin-bottom: 30px;
  padding: 20px;
  background: #f8fafc;
  border-radius: 12px;
  border: 1px solid #e2e8f0;
}

.search-box {
  position: relative;
  flex: 1;
}

.search-box input {
  width: 100%;
  padding: 12px 40px 12px 16px;
  border: 2px solid #e2e8f0;
  border-radius: 8px;
  font-size: 1rem;
  transition: all 0.3s ease;
}

.search-box input:focus {
  outline: none;
  border-color: #667eea;
  box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
}

.search-icon {
  position: absolute;
  right: 12px;
  top: 50%;
  transform: translateY(-50%);
  color: #6b7280;
}

.energies-list {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(400px, 1fr));
  gap: 20px;
}

.energie-card {
  background: white;
  border-radius: 12px;
  padding: 20px;
  border: 2px solid #e2e8f0;
  transition: all 0.3s ease;
  min-height: 260px; /* Unifier la hauteur des cartes */
  display: flex;
  flex-direction: column;
}

.energie-card:hover {
  border-color: #667eea;
  box-shadow: 0 8px 25px rgba(102, 126, 234, 0.15);
  transform: translateY(-2px);
}

.energie-header {
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  margin-bottom: 15px;
}

.energie-info h3 {
  margin: 0 0 5px 0;
  font-size: 1.2rem;
  color: #1f2937;
}

.energie-id {
  font-size: 0.9rem;
  color: #6b7280;
  font-family: monospace;
}

.energie-badge {
  display: flex;
  gap: 8px;
}

.badge-unit {
  padding: 6px 12px;
  background: #dbeafe;
  color: #1e40af;
  border-radius: 20px;
  font-size: 0.8rem;
  font-weight: 600;
}

.energie-details {
  margin-bottom: 20px;
  flex: 1; /* Prendre l'espace disponible pour centrer le contenu */
}

.detail-row {
  display: flex;
  justify-content: space-between;
  padding: 8px 0;
  border-bottom: 1px solid #f3f4f6;
}

.detail-row:last-child {
  border-bottom: none;
}

.detail-label {
  font-weight: 600;
  color: #4b5563;
}

.detail-value {
  color: #1f2937;
}

.energie-actions {
  display: flex;
  gap: 10px;
  flex-wrap: wrap;
}

.btn-edit, .btn-delete {
  flex: 1;
  min-width: 120px;
  padding: 10px 16px;
  border: none;
  border-radius: 8px;
  font-size: 0.9rem;
  cursor: pointer;
  transition: all 0.3s ease;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
}



.btn-facteurs-inline {
  background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
  color: white;
  border: none;
  padding: 12px 20px;
  border-radius: 8px;
  font-size: 0.9rem;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s ease;
  display: flex;
  align-items: center;
  gap: 8px;
  width: 100%;
  justify-content: center;
}

.btn-facteurs-inline:hover {
  background: linear-gradient(135deg, #7c3aed 0%, #6d28d9 100%);
  transform: translateY(-1px);
  box-shadow: 0 4px 15px rgba(139, 92, 246, 0.3);
}

.btn-edit {
  background: #3b82f6;
  color: white;
}

.btn-edit:hover {
  background: #2563eb;
  transform: translateY(-1px);
}

.btn-delete {
  background: #ef4444;
  color: white;
}

.btn-delete:hover {
  background: #dc2626;
  transform: translateY(-1px);
}

/* Modal styles */
.modal {
  display: none;
  position: fixed;
  z-index: 1000;
  left: 0;
  top: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0, 0, 0, 0.5);
}

.modal-content {
  background-color: white;
  margin: 5% auto;
  padding: 0;
  border-radius: 15px;
  width: 90%;
  max-width: 800px;
  max-height: 90vh;
  overflow-y: auto;
  box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
}

.modal-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 20px 30px;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  border-radius: 15px 15px 0 0;
}

.modal-header h2 {
  margin: 0;
  font-size: 1.5rem;
}

.close-btn {
  background: none;
  border: none;
  color: white;
  font-size: 2rem;
  cursor: pointer;
  padding: 0;
  width: 30px;
  height: 30px;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 50%;
  transition: background-color 0.3s ease;
}

.close-btn:hover {
  background-color: rgba(255, 255, 255, 0.2);
}

.energie-form, .facteurs-form {
  padding: 30px;
}

.facteurs-content {
  padding: 30px;
}

.energie-info {
  text-align: center;
  margin-bottom: 30px;
  padding: 20px;
  background: #f8fafc;
  border-radius: 12px;
  border: 1px solid #e2e8f0;
}

.energie-info h3 {
  margin: 0 0 10px 0;
  color: #1f2937;
  font-size: 1.5rem;
}

.energie-info p {
  margin: 0;
  color: #6b7280;
  font-size: 1.1rem;
}

.form-row {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 20px;
  margin-bottom: 20px;
}

.form-group {
  display: flex;
  flex-direction: column;
}

.form-group label {
  font-size: 0.9rem;
  font-weight: 600;
  color: #2d3748;
  margin-bottom: 8px;
}

.form-group input,
.form-group select,
.form-group textarea {
  padding: 12px;
  border: 2px solid #e2e8f0;
  border-radius: 8px;
  font-size: 1rem;
  transition: all 0.3s ease;
}

.form-group input:focus,
.form-group select:focus,
.form-group textarea:focus {
  outline: none;
  border-color: #667eea;
  box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
}

.form-group input[readonly] {
  background-color: #f7fafc;
  color: #4a5568;
  cursor: not-allowed;
}

.form-help {
  font-size: 0.8rem;
  color: #718096;
  margin-top: 5px;
  font-style: italic;
}

.form-actions {
  display: flex;
  gap: 15px;
  justify-content: flex-end;
  margin-top: 30px;
  padding-top: 20px;
  border-top: 1px solid #e2e8f0;
}

.btn-save, .btn-cancel {
  padding: 12px 24px;
  border: none;
  border-radius: 8px;
  font-size: 1rem;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s ease;
}

.btn-save {
  background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
  color: white;
  box-shadow: 0 4px 15px rgba(72, 187, 120, 0.3);
}

.btn-save:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 20px rgba(72, 187, 120, 0.4);
}

.btn-cancel {
  background: linear-gradient(135deg, #f56565 0%, #e53e3e 100%);
  color: white;
  box-shadow: 0 4px 15px rgba(245, 101, 101, 0.3);
}

.btn-cancel:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 20px rgba(245, 101, 101, 0.4);
}

.no-energies {
  text-align: center;
  padding: 60px 20px;
  color: #6b7280;
  font-style: italic;
  background: #f9fafb;
  border-radius: 12px;
  border: 2px dashed #d1d5db;
  grid-column: 1 / -1;
}

/* Styles pour les nouvelles sections */
.section-title {
  margin: 30px 0 20px 0;
  padding: 20px;
  background: #f8fafc;
  border-radius: 12px;
  border-left: 4px solid #667eea;
}

.section-title h4 {
  margin: 0 0 10px 0;
  color: #1f2937;
  font-size: 1.2rem;
}

.section-title p {
  margin: 0;
  color: #6b7280;
  font-size: 0.9rem;
}

.add-value-section {
  text-align: center;
  margin: 20px 0;
}

.btn-add-value {
  background: linear-gradient(135deg, #10b981 0%, #059669 100%);
  color: white;
  border: none;
  padding: 15px 30px;
  border-radius: 8px;
  font-size: 1rem;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s ease;
  display: inline-flex;
  align-items: center;
  gap: 10px;
  box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3);
}

.btn-add-value:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 20px rgba(16, 185, 129, 0.4);
}

.add-value-form {
  background: #f8fafc;
  border: 2px solid #e2e8f0;
  border-radius: 12px;
  padding: 20px;
  margin: 20px 0;
}

.add-value-form h5 {
  margin: 0 0 20px 0;
  color: #1f2937;
  font-size: 1.1rem;
}

.form-actions-inline {
  display: flex;
  gap: 15px;
  justify-content: flex-end;
  margin-top: 20px;
}

.values-list-section {
  margin: 30px 0;
}

.values-list-section h5 {
  margin: 0 0 20px 0;
  color: #1f2937;
  font-size: 1.1rem;
}

.values-list {
  display: flex;
  flex-direction: column;
  gap: 15px;
}

.value-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 15px;
  background: white;
  border: 2px solid #e2e8f0;
  border-radius: 8px;
  transition: all 0.3s ease;
}

.value-item:hover {
  border-color: #667eea;
  box-shadow: 0 2px 8px rgba(102, 126, 234, 0.1);
}

.value-info {
  flex: 1;
}

.value-name {
  font-weight: 600;
  color: #1f2937;
  margin-bottom: 5px;
}

.value-details {
  display: flex;
  gap: 15px;
  align-items: center;
}

.value-valeur {
  font-weight: 500;
  color: #059669;
  background: #d1fae5;
  padding: 4px 8px;
  border-radius: 4px;
  font-size: 0.9rem;
}

.value-description {
  color: #6b7280;
  font-size: 0.9rem;
  font-style: italic;
}

.value-actions {
  display: flex;
  gap: 8px;
}

.btn-edit-small, .btn-delete-small {
  background: none;
  border: none;
  font-size: 1.2rem;
  cursor: pointer;
  padding: 8px;
  border-radius: 4px;
  transition: all 0.3s ease;
}

.btn-edit-small:hover {
  background: #dbeafe;
  color: #1e40af;
}

.btn-delete-small:hover {
  background: #fee2e2;
  color: #dc2626;
}

.no-values {
  text-align: center;
  padding: 40px 20px;
  color: #6b7280;
  font-style: italic;
  background: #f9fafb;
  border-radius: 8px;
  border: 2px dashed #d1d5db;
}

/* Responsive design */
@media (max-width: 768px) {
  .page-header {
    flex-direction: column;
    gap: 20px;
    text-align: center;
  }
  
  .energies-list {
    grid-template-columns: 1fr;
  }
  
  .form-row {
    grid-template-columns: 1fr;
  }
  
  .modal-content {
    width: 95%;
    margin: 2% auto;
  }
  
  .energie-form, .facteurs-form, .facteurs-content {
    padding: 20px;
  }
  
  .energie-actions {
    flex-direction: column;
  }
  
  .btn-edit, .btn-delete {
    min-width: auto;
  }
  
  .value-item {
    flex-direction: column;
    align-items: flex-start;
    gap: 15px;
  }
  
  .value-details {
    flex-direction: column;
    align-items: flex-start;
    gap: 8px;
  }
  
  .value-actions {
    align-self: flex-end;
  }
}
</style>
{% endblock %}
