<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Calculs Phases</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        
        .test-container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .test-button {
            background: #2a7de1;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 10px;
            font-size: 16px;
        }
        
        .test-button:hover {
            background: #1e5bb8;
        }
        
        .test-result {
            margin: 20px 0;
            padding: 15px;
            border-radius: 5px;
            background: #f8f9fa;
            border-left: 4px solid #28a745;
        }
        
        .test-error {
            border-left-color: #dc3545;
            background: #f8d7da;
        }
        
        .test-info {
            border-left-color: #17a2b8;
            background: #d1ecf1;
        }
        
        .phase-form-container {
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 20px;
            margin: 20px 0;
            background: #f9f9f9;
        }
        
        .form-row {
            display: flex;
            gap: 20px;
            margin-bottom: 15px;
        }
        
        .form-group {
            flex: 1;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        
        .form-group input,
        .form-group select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        
        .form-actions {
            text-align: right;
            margin-top: 20px;
        }
        
        .btn-save-phase {
            background: #28a745;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
        }
        
        .btn-cancel-phase {
            background: #6c757d;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 10px;
        }
        
        .calculations-panel {
            background: #e8f4fd;
            border: 1px solid #bee5eb;
            border-radius: 5px;
            padding: 15px;
            margin: 20px 0;
        }
        
        .calculation-step {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 10px;
            margin: 10px 0;
        }
        
        .calculation-result {
            font-weight: bold;
            color: #28a745;
        }
        
        .calculation-formula {
            font-family: monospace;
            background: #f8f9fa;
            padding: 5px;
            border-radius: 3px;
            margin: 5px 0;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>üßÆ Test des Calculs des Phases de Transport</h1>
        
        <div class="test-info">
            <h3>Objectif du test</h3>
            <p>V√©rifier que les calculs automatiques des √©missions fonctionnent correctement lors de l'ajout et de la modification des phases.</p>
        </div>
        
        <div class="test-result">
            <h3>‚úÖ Probl√®me identifi√© et corrig√©</h3>
            <p><strong>Probl√®me :</strong> Dans l'ajout d'une phase, les calculs automatiques des √©missions ne se d√©clenchaient pas.</p>
            
            <p><strong>Cause :</strong> Les event listeners JavaScript n'√©taient pas attach√©s au formulaire lors de l'affichage, emp√™chant le d√©clenchement automatique des calculs.</p>
            
            <p><strong>Solution :</strong> Cr√©ation d'une fonction <code>attachPhaseFormListeners()</code> qui attache tous les event listeners n√©cessaires et l'appel dans <code>showAddPhaseForm()</code>.</p>
        </div>
        
        <h3>üîß Corrections apport√©es</h3>
        
        <div class="test-result">
            <h4>1. Nouvelle fonction attachPhaseFormListeners()</h4>
            <ul>
                <li>Attache automatiquement tous les event listeners n√©cessaires</li>
                <li>G√®re les changements de type de phase, v√©hicule, distance, poids, √©nergie, consommation</li>
                <li>D√©clenche automatiquement les calculs √† chaque modification</li>
                <li>Logs d√©taill√©s pour le d√©bogage</li>
            </ul>
        </div>
        
        <div class="test-result">
            <h4>2. Am√©lioration de showAddPhaseForm()</h4>
            <ul>
                <li>Appel automatique de <code>attachPhaseFormListeners()</code></li>
                <li>Calcul initial automatique apr√®s affichage du formulaire</li>
                <li>Gestion des erreurs avec event listeners quand m√™me</li>
            </ul>
        </div>
        
        <div class="test-result">
            <h4>3. Am√©lioration de updateEmissionsCalculation()</h4>
            <ul>
                <li>Calcul des √©missions totales m√™me sans √©nergie s√©lectionn√©e</li>
                <li>Meilleure gestion des cas partiels</li>
                <li>Logs d√©taill√©s des calculs effectu√©s</li>
            </ul>
        </div>
        
        <h3>üìã Formulaire de test avec calculs</h3>
        
        <div class="phase-form-container" id="phase-form-test" style="display: none;">
            <div class="phase-form-header">
                <h5 id="phase-form-title">Ajouter une nouvelle phase</h5>
                <button class="btn-close-form" onclick="hideTestForm()">√ó</button>
            </div>
            
            <form class="phase-form" id="phase-form-test-form">
                <div class="form-row">
                    <div class="form-group">
                        <label for="phase-type">Type de phase *</label>
                        <select id="phase-type" name="type_phase" required>
                            <option value="">S√©lectionner le type de phase</option>
                            <option value="COLLECTE">üì¶ Phase de collecte</option>
                            <option value="TRACTION">üöö Phase de traction</option>
                            <option value="DISTRIBUTION">üìã Phase de distribution</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="phase-camion">V√©hicule *</label>
                        <select id="phase-camion" name="vehicule_id" required>
                            <option value="">S√©lectionner un v√©hicule</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="phase-ville-depart">Ville de d√©part *</label>
                        <input type="text" id="phase-ville-depart" name="ville_depart" required placeholder="Ex: Paris">
                    </div>
                    <div class="form-group">
                        <label for="phase-ville-arrivee">Ville d'arriv√©e *</label>
                        <input type="text" id="phase-ville-arrivee" name="ville_arrivee" required placeholder="Ex: Lyon">
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="phase-distance">Distance (km) *</label>
                        <input type="number" id="phase-distance" name="distance_km" required step="0.1" min="0" placeholder="Ex: 465.2">
                    </div>
                    <div class="form-group">
                        <label for="phase-poids">Poids (tonnes) *</label>
                        <input type="number" id="phase-poids" name="poids_tonnes" required step="0.001" min="0" placeholder="Ex: 12.5">
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="phase-energie">√ânergie utilis√©e</label>
                        <select id="phase-energie" name="energie">
                            <option value="">S√©lectionner une √©nergie</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="phase-consommation">Consommation</label>
                        <input type="number" id="phase-consommation" name="consommation" step="0.01" min="0" placeholder="Ex: 45.2">
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="phase-emis-vehicule">√âmissions GES v√©hicule (kg CO‚ÇÇe)</label>
                        <input type="number" id="phase-emis-vehicule" name="emis_vehicule" step="0.01" min="0" placeholder="Calcul√© automatiquement" readonly>
                    </div>
                    <div class="form-group">
                        <label for="phase-emis-transport">√âmission tonnes Km (CO‚ÇÇe/t.km)</label>
                        <input type="number" id="phase-emis-transport" name="emis_transport" step="0.01" min="0" placeholder="Calcul√© automatiquement" readonly>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="phase-emis-total">√âmissions totales (kg CO‚ÇÇe)</label>
                        <input type="number" id="phase-emis-total" name="emis_total" step="0.01" min="0" placeholder="Calcul√© automatiquement" readonly>
                    </div>
                    <div class="form-group">
                        <label for="phase-emis-tkm">Facteur transport (kg CO‚ÇÇe/t.km)</label>
                        <input type="number" id="phase-emis-tkm" name="emis_tkm" step="0.001" min="0" placeholder="Facteur de l'√©nergie" readonly>
                    </div>
                </div>
                
                <div class="form-actions">
                    <button type="submit" class="btn-save-phase">üíæ Sauvegarder la phase</button>
                    <button type="button" class="btn-cancel-phase" onclick="hideTestForm()">‚ùå Annuler</button>
                </div>
            </form>
        </div>
        
        <div class="calculations-panel">
            <h3>üßÆ D√©tail des Calculs</h3>
            <div id="calculations-detail">
                <p>Remplissez le formulaire ci-dessus pour voir les calculs en temps r√©el.</p>
            </div>
        </div>
        
        <div class="test-result">
            <h3>üß™ Tests √† effectuer</h3>
            <ol>
                <li><strong>Test d'affichage :</strong> Cliquer sur "Afficher le formulaire" et v√©rifier qu'il s'affiche</li>
                <li><strong>Test de calculs automatiques :</strong> Remplir la distance et le poids, v√©rifier que les calculs se d√©clenchent</li>
                <li><strong>Test de s√©lection d'√©nergie :</strong> S√©lectionner une √©nergie et v√©rifier que l'unit√© et les facteurs se mettent √† jour</li>
                <li><strong>Test de consommation :</strong> Remplir la consommation et v√©rifier que les √©missions v√©hicule se calculent</li>
                <li><strong>Test de modification :</strong> Modifier les valeurs et v√©rifier que les calculs se mettent √† jour en temps r√©el</li>
            </ol>
        </div>
        
        <div class="test-result">
            <h3>üìù Instructions de test</h3>
            <p>1. Ouvrir la console du navigateur pour voir les logs d√©taill√©s</p>
            <p>2. Cliquer sur "Afficher le formulaire"</p>
            <p>3. Remplir progressivement les champs et observer les calculs automatiques</p>
            <p>4. V√©rifier que les √©missions se calculent en temps r√©el</p>
            <p>5. Tester diff√©rents sc√©narios (avec/sans √©nergie, diff√©rentes valeurs)</p>
        </div>
        
        <button class="test-button" onclick="showTestForm()">üìã Afficher le formulaire</button>
        <button class="test-button" onclick="testCalculations()">üßÆ Tester les calculs</button>
        <button class="test-button" onclick="hideTestForm()">‚ùå Masquer le formulaire</button>
        <button class="test-button" onclick="clearCalculations()">üóëÔ∏è Effacer les calculs</button>
        
        <div id="test-results"></div>
    </div>
    
    <script>
        // Simulation des donn√©es d'√©nergies
        const mockEnergies = {
            'gazole': { nom: 'Gazole', facteur: 2.6, unite: 'kg/L' },
            'essence': { nom: 'Essence', facteur: 2.3, unite: 'kg/L' },
            'electricite': { nom: '√âlectricit√©', facteur: 0.05, unite: 'kg/kWh' }
        };
        
        // Simulation des donn√©es de v√©hicules
        const mockVehicules = [
            { id: 'CAM001', nom: 'Camion 3.5t', type: 'Porteur' },
            { id: 'CAM002', nom: 'Camion 7.5t', type: 'Porteur' },
            { id: 'CAM003', nom: 'Camion 19t', type: 'Porteur' }
        ];
        
        function showTestForm() {
            const form = document.getElementById('phase-form-test');
            form.style.display = 'block';
            
            // Charger les √©nergies et v√©hicules
            loadTestEnergies();
            loadTestVehicules();
            
            // Attacher les event listeners
            attachTestListeners();
            
            console.log('‚úÖ Formulaire d\'ajout affich√© avec event listeners');
            addTestResult('Formulaire d\'ajout affich√© avec succ√®s et event listeners attach√©s', 'success');
        }
        
        function hideTestForm() {
            const form = document.getElementById('phase-form-test');
            form.style.display = 'none';
            console.log('‚úÖ Formulaire masqu√©');
            addTestResult('Formulaire masqu√© avec succ√®s', 'success');
        }
        
        function loadTestEnergies() {
            const energieSelect = document.getElementById('phase-energie');
            energieSelect.innerHTML = '<option value="">S√©lectionner une √©nergie</option>';
            
            Object.entries(mockEnergies).forEach(([id, energie]) => {
                const option = document.createElement('option');
                option.value = id;
                option.textContent = `${energie.nom} (${energie.facteur} kg CO‚ÇÇe/t.km)`;
                option.setAttribute('data-facteur', energie.facteur);
                energieSelect.appendChild(option);
            });
            
            console.log('‚úÖ √ânergies charg√©es:', mockEnergies);
        }
        
        function loadTestVehicules() {
            const vehiculeSelect = document.getElementById('phase-camion');
            vehiculeSelect.innerHTML = '<option value="">S√©lectionner un v√©hicule</option>';
            
            mockVehicules.forEach(vehicule => {
                const option = document.createElement('option');
                option.value = vehicule.id;
                option.textContent = `${vehicule.id} - ${vehicule.nom} (${vehicule.type})`;
                vehiculeSelect.appendChild(option);
            });
            
            console.log('‚úÖ V√©hicules charg√©s:', mockVehicules);
        }
        
        function attachTestListeners() {
            console.log('üîó Attachement des event listeners de test');
            
            // Event listeners pour les calculs automatiques
            const distanceInput = document.getElementById('phase-distance');
            const poidsInput = document.getElementById('phase-poids');
            const energieSelect = document.getElementById('phase-energie');
            const consommationInput = document.getElementById('phase-consommation');
            
            if (distanceInput) {
                distanceInput.addEventListener('input', updateTestCalculations);
                distanceInput.addEventListener('change', updateTestCalculations);
            }
            
            if (poidsInput) {
                poidsInput.addEventListener('input', updateTestCalculations);
                poidsInput.addEventListener('change', updateTestCalculations);
            }
            
            if (energieSelect) {
                energieSelect.addEventListener('change', updateTestCalculations);
            }
            
            if (consommationInput) {
                consommationInput.addEventListener('input', updateTestCalculations);
                consommationInput.addEventListener('change', updateTestCalculations);
            }
            
            console.log('‚úÖ Event listeners de test attach√©s');
        }
        
        function updateTestCalculations() {
            console.log('üîÑ Mise √† jour des calculs de test');
            
            const distance = parseFloat(document.getElementById('phase-distance').value) || 0;
            const poids = parseFloat(document.getElementById('phase-poids').value) || 0;
            const energie = document.getElementById('phase-energie').value;
            const consommation = parseFloat(document.getElementById('phase-consommation').value) || 0;
            
            let calculsDetail = '<h4>üìä Calculs en temps r√©el</h4>';
            
            if (distance > 0 && poids > 0) {
                // Calculs de base
                calculsDetail += `
                    <div class="calculation-step">
                        <strong>Distance :</strong> ${distance} km<br>
                        <strong>Poids :</strong> ${poids} tonnes
                    </div>
                `;
                
                if (energie && mockEnergies[energie]) {
                    const facteur = mockEnergies[energie].facteur;
                    const unite = mockEnergies[energie].unite;
                    
                    calculsDetail += `
                        <div class="calculation-step">
                            <strong>√ânergie s√©lectionn√©e :</strong> ${energie}<br>
                            <strong>Facteur d'√©mission :</strong> ${facteur} kg CO‚ÇÇe/t.km<br>
                            <strong>Unit√© :</strong> ${unite}
                        </div>
                    `;
                    
                    // Calculs des √©missions
                    if (consommation > 0) {
                        let emissionsVehicule = 0;
                        let uniteConsommation = 'L/100km';
                        
                        if (energie === 'electricite') {
                            uniteConsommation = 'kWh/100km';
                            const consommationParKm = consommation / 100;
                            const consommationTotale = consommationParKm * distance;
                            emissionsVehicule = consommationTotale * facteur;
                            
                            calculsDetail += `
                                <div class="calculation-step">
                                    <strong>Consommation v√©hicule :</strong><br>
                                    <div class="calculation-formula">${consommation} kWh/100km ‚Üí ${consommationParKm.toFixed(3)} kWh/km</div>
                                    <div class="calculation-formula">Consommation totale : ${consommationParKm.toFixed(3)} kWh/km √ó ${distance} km = ${consommationTotale.toFixed(2)} kWh</div>
                                    <div class="calculation-formula">√âmissions v√©hicule : ${consommationTotale.toFixed(2)} kWh √ó ${facteur} kg CO‚ÇÇe/kWh = <span class="calculation-result">${emissionsVehicule.toFixed(2)} kg CO‚ÇÇe</span></div>
                                </div>
                            `;
                        } else {
                            const consommationParKm = consommation / 100;
                            const consommationTotale = consommationParKm * distance;
                            emissionsVehicule = consommationTotale * facteur;
                            
                            calculsDetail += `
                                <div class="calculation-step">
                                    <strong>Consommation v√©hicule :</strong><br>
                                    <div class="calculation-formula">${consommation} L/100km ‚Üí ${consommationParKm.toFixed(3)} L/km</div>
                                    <div class="calculation-formula">Consommation totale : ${consommationParKm.toFixed(3)} L/km √ó ${distance} km = ${consommationTotale.toFixed(2)} L</div>
                                    <div class="calculation-formula">√âmissions v√©hicule : ${consommationTotale.toFixed(2)} L √ó ${facteur} kg CO‚ÇÇe/L = <span class="calculation-result">${emissionsVehicule.toFixed(2)} kg CO‚ÇÇe</span></div>
                                </div>
                            `;
                        }
                        
                        // Mettre √† jour le champ d'√©missions v√©hicule
                        document.getElementById('phase-emis-vehicule').value = emissionsVehicule.toFixed(2);
                    }
                    
                    // Calculs des √©missions de transport
                    const emissionsTransport = distance * poids * facteur;
                    calculsDetail += `
                        <div class="calculation-step">
                            <strong>√âmissions de transport :</strong><br>
                            <div class="calculation-formula">Distance √ó Poids √ó Facteur = ${distance} km √ó ${poids} t √ó ${facteur} kg CO‚ÇÇe/t.km</div>
                            <div class="calculation-result">√âmissions transport : ${emissionsTransport.toFixed(2)} kg CO‚ÇÇe</div>
                        </div>
                    `;
                    
                    // Mettre √† jour les champs
                    document.getElementById('phase-emis-transport').value = emissionsTransport.toFixed(2);
                    document.getElementById('phase-emis-tkm').value = facteur.toFixed(3);
                    
                    // Calculs des √©missions totales
                    const emissionsTotal = (parseFloat(document.getElementById('phase-emis-vehicule').value) || 0) + emissionsTransport;
                    calculsDetail += `
                        <div class="calculation-step">
                            <strong>√âmissions totales :</strong><br>
                            <div class="calculation-formula">√âmissions v√©hicule + √âmissions transport = ${(parseFloat(document.getElementById('phase-emis-vehicule').value) || 0).toFixed(2)} + ${emissionsTransport.toFixed(2)}</div>
                            <div class="calculation-result">√âmissions totales : ${emissionsTotal.toFixed(2)} kg CO‚ÇÇe</div>
                        </div>
                    `;
                    
                    document.getElementById('phase-emis-total').value = emissionsTotal.toFixed(2);
                    
                } else {
                    // Pas d'√©nergie s√©lectionn√©e
                    calculsDetail += `
                        <div class="calculation-step">
                            <strong>Calculs partiels (sans √©nergie) :</strong><br>
                            <div class="calculation-formula">Distance √ó Poids √ó Facteur estim√© = ${distance} km √ó ${poids} t √ó 1.0</div>
                            <div class="calculation-result">√âmissions transport estim√©es : ${(distance * poids * 1.0).toFixed(2)} kg CO‚ÇÇe (facteur estim√©)</div>
                        </div>
                    `;
                    
                    document.getElementById('phase-emis-transport').value = `${(distance * poids * 1.0).toFixed(2)} (facteur estim√©)`;
                    document.getElementById('phase-emis-total').value = (distance * poids * 1.0).toFixed(2);
                    document.getElementById('phase-emis-tkm').value = '';
                }
                
            } else {
                calculsDetail += '<p>Aucun calcul possible sans distance et poids.</p>';
            }
            
            document.getElementById('calculations-detail').innerHTML = calculsDetail;
        }
        
        function testCalculations() {
            console.log('üß™ Test des calculs automatiques');
            addTestResult('Test des calculs automatiques lanc√©', 'info');
            
            // Remplir automatiquement quelques champs pour tester
            document.getElementById('phase-distance').value = '100';
            document.getElementById('phase-poids').value = '5';
            document.getElementById('phase-energie').value = 'gazole';
            document.getElementById('phase-consommation').value = '25';
            
            // D√©clencher les calculs
            updateTestCalculations();
            
            addTestResult('Test des calculs automatiques termin√© - v√©rifiez les r√©sultats', 'success');
        }
        
        function clearCalculations() {
            document.getElementById('calculations-detail').innerHTML = '<p>Remplissez le formulaire ci-dessus pour voir les calculs en temps r√©el.</p>';
            addTestResult('Calculs effac√©s', 'info');
        }
        
        function addTestResult(message, type) {
            const resultsDiv = document.getElementById('test-results');
            const resultDiv = document.createElement('div');
            resultDiv.className = `test-result ${type === 'error' ? 'test-error' : type === 'info' ? 'test-info' : ''}`;
            resultDiv.innerHTML = `<strong>${new Date().toLocaleTimeString()}:</strong> ${message}`;
            resultsDiv.appendChild(resultDiv);
        }
        
        // Gestion du formulaire
        document.getElementById('phase-form-test-form').addEventListener('submit', function(e) {
            e.preventDefault();
            console.log('üì§ Soumission du formulaire de test');
            addTestResult('Formulaire de test soumis avec succ√®s', 'success');
        });
        
        console.log('üß™ Page de test des calculs des phases charg√©e');
        addTestResult('Page de test des calculs charg√©e - pr√™t pour les tests', 'info');
    </script>
</body>
</html>


















