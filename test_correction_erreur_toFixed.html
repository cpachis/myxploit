<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Correction Erreur TypeError toFixed</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .test-section {
            background: #f0f8ff;
            padding: 20px;
            border-radius: 8px;
            border-left: 4px solid #007acc;
            margin: 20px 0;
        }
        .test-section h3 {
            color: #007acc;
            margin-top: 0;
        }
        .error-section {
            background: #f8d7da;
            padding: 20px;
            border-radius: 8px;
            border-left: 4px solid #dc3545;
            margin: 20px 0;
        }
        .error-section h3 {
            color: #721c24;
            margin-top: 0;
        }
        .success-section {
            background: #d4edda;
            padding: 20px;
            border-radius: 8px;
            border-left: 4px solid #28a745;
            margin: 20px 0;
        }
        .success-section h3 {
            color: #155724;
            margin-top: 0;
        }
        .btn {
            background: #007acc;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
        }
        .btn:hover {
            background: #005a9e;
        }
        .btn-danger {
            background: #dc3545;
        }
        .btn-danger:hover {
            background: #c53030;
        }
        .btn-success {
            background: #28a745;
        }
        .btn-success:hover {
            background: #218838;
        }
        .log {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 15px;
            margin: 10px 0;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            max-height: 300px;
            overflow-y: auto;
        }
        .log.error {
            background: #f8d7da;
            border-color: #dc3545;
            color: #721c24;
        }
        .log.success {
            background: #d4edda;
            border-color: #28a745;
            color: #155724;
        }
    </style>
</head>
<body>
    <h1>üîß Test Correction Erreur TypeError toFixed</h1>
    
    <div class="container">
        <h2>üìã Probl√®me Identifi√©</h2>
        
        <div class="error-section">
            <h3>‚ùå Erreur Originale :</h3>
            <p><strong>TypeError: kgCO2eTkm.toFixed is not a function</strong></p>
            <p>Cette erreur se produisait quand <code>kgCO2eTkm</code> n'√©tait pas un nombre valide.</p>
        </div>
        
        <div class="test-section">
            <h3>üîç Cause de l'Erreur :</h3>
            <p>Dans le code original, la variable <code>emissionsNiveau1ParTonneKm</code> √©tait initialis√©e comme une cha√Æne vide (<code>''</code>) et pouvait rester une cha√Æne vide si la capacit√© du v√©hicule n'√©tait pas d√©finie.</p>
            <p>Ensuite, cette cha√Æne vide √©tait pass√©e √† <code>updateEmissionsInHeader</code> qui essayait d'appeler <code>.toFixed()</code> dessus, causant l'erreur.</p>
        </div>
    </div>
    
    <div class="container">
        <h2>‚úÖ Solution Impl√©ment√©e</h2>
        
        <div class="success-section">
            <h3>1. Initialisation Corrig√©e :</h3>
            <p><code>let emissionsNiveau1ParTonneKm = 0;</code> au lieu de <code>let emissionsNiveau1ParTonneKm = '';</code></p>
        </div>
        
        <div class="success-section">
            <h3>2. Conversion en Nombre :</h3>
            <p><code>emissionsNiveau1ParTonneKm = parseFloat((emissionsNiveau1 / tonneKm).toFixed(2));</code></p>
        </div>
        
        <div class="success-section">
            <h3>3. Validation dans updateEmissionsInHeader :</h3>
            <p>Ajout de v√©rifications pour s'assurer que les valeurs sont des nombres valides avant d'appeler <code>.toFixed()</code></p>
        </div>
    </div>
    
    <div class="container">
        <h2>üß™ Tests de la Correction</h2>
        
        <div class="test-section">
            <h3>Test avec Valeurs Valides :</h3>
            <button class="btn btn-success" onclick="testValidValues()">Tester Valeurs Valides</button>
            <button class="btn btn-danger" onclick="testInvalidValues()">Tester Valeurs Invalides</button>
            <button class="btn" onclick="clearLog()">Effacer les Logs</button>
        </div>
        
        <div class="log" id="test-log">
            <strong>Logs de test :</strong><br>
            Cliquez sur les boutons pour tester la correction...
        </div>
    </div>
    
    <div class="container">
        <h2>üìä Code Corrig√©</h2>
        
        <div class="test-section">
            <h3>Fonction updateEmissionsInHeader Corrig√©e :</h3>
            <pre><code>function updateEmissionsInHeader(transportRef, niveau, kgCO2e, kgCO2eTkm) {
  const kgCO2eElement = document.getElementById(`${niveau}-kg-co2e-${transportRef}`);
  const kgCO2eTkmElement = document.getElementById(`${niveau}-kg-co2e-tkm-${transportRef}`);
  
  // S'assurer que les valeurs sont des nombres valides
  const kgCO2eValue = typeof kgCO2e === 'number' && !isNaN(kgCO2e) ? kgCO2e : 0;
  const kgCO2eTkmValue = typeof kgCO2eTkm === 'number' && !isNaN(kgCO2eTkm) ? kgCO2eTkm : 0;
  
  if (kgCO2eElement) {
    kgCO2eElement.textContent = kgCO2eValue > 0 ? kgCO2eValue.toFixed(1) : '-';
  }
  
  if (kgCO2eTkmElement) {
    kgCO2eTkmElement.textContent = kgCO2eTkmValue > 0 ? kgCO2eTkmValue.toFixed(3) : '-';
  }
}</code></pre>
        </div>
    </div>

    <script>
        // Simulation de la fonction corrig√©e
        function updateEmissionsInHeader(transportRef, niveau, kgCO2e, kgCO2eTkm) {
            // S'assurer que les valeurs sont des nombres valides
            const kgCO2eValue = typeof kgCO2e === 'number' && !isNaN(kgCO2e) ? kgCO2e : 0;
            const kgCO2eTkmValue = typeof kgCO2eTkm === 'number' && !isNaN(kgCO2eTkm) ? kgCO2eTkm : 0;
            
            const result = {
                kgCO2e: kgCO2eValue > 0 ? kgCO2eValue.toFixed(1) : '-',
                kgCO2eTkm: kgCO2eTkmValue > 0 ? kgCO2eTkmValue.toFixed(3) : '-'
            };
            
            logToConsole(`‚úÖ √âmissions ${niveau} mises √† jour:`, result, 'success');
            return result;
        }
        
        function testValidValues() {
            logToConsole('üß™ Test avec valeurs valides...', '', 'success');
            
            try {
                const result1 = updateEmissionsInHeader('T001', 'niveau1', 45.67, 0.125);
                logToConsole('Test 1 - Valeurs normales:', result1, 'success');
                
                const result2 = updateEmissionsInHeader('T002', 'niveau2', 123.456, 0.789);
                logToConsole('Test 2 - Valeurs d√©cimales:', result2, 'success');
                
                logToConsole('‚úÖ Tous les tests avec valeurs valides ont r√©ussi !', '', 'success');
            } catch (error) {
                logToConsole('‚ùå Erreur lors du test avec valeurs valides:', error.message, 'error');
            }
        }
        
        function testInvalidValues() {
            logToConsole('üß™ Test avec valeurs invalides...', '', 'success');
            
            try {
                const result1 = updateEmissionsInHeader('T003', 'niveau1', '', 0);
                logToConsole('Test 1 - Cha√Æne vide:', result1, 'success');
                
                const result2 = updateEmissionsInHeader('T004', 'niveau2', null, undefined);
                logToConsole('Test 2 - null/undefined:', result2, 'success');
                
                const result3 = updateEmissionsInHeader('T005', 'niveau3', 'abc', 'xyz');
                logToConsole('Test 3 - Cha√Ænes non num√©riques:', result3, 'success');
                
                const result4 = updateEmissionsInHeader('T006', 'niveau4', NaN, Infinity);
                logToConsole('Test 4 - NaN/Infinity:', result4, 'success');
                
                logToConsole('‚úÖ Tous les tests avec valeurs invalides ont r√©ussi !', '', 'success');
            } catch (error) {
                logToConsole('‚ùå Erreur lors du test avec valeurs invalides:', error.message, 'error');
            }
        }
        
        function logToConsole(message, data, type = '') {
            const logElement = document.getElementById('test-log');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${message}${data ? ' ' + JSON.stringify(data, null, 2) : ''}`;
            
            if (type === 'error') {
                logElement.innerHTML += `<div class="log error">${logEntry}</div>`;
            } else if (type === 'success') {
                logElement.innerHTML += `<div class="log success">${logEntry}</div>`;
            } else {
                logElement.innerHTML += `<div class="log">${logEntry}</div>`;
            }
            
            // Auto-scroll vers le bas
            logElement.scrollTop = logElement.scrollHeight;
        }
        
        function clearLog() {
            document.getElementById('test-log').innerHTML = '<strong>Logs de test :</strong><br>Logs effac√©s...';
        }
        
        // Test automatique au chargement
        document.addEventListener('DOMContentLoaded', function() {
            logToConsole('üöÄ Page de test charg√©e. Cliquez sur les boutons pour tester la correction.', '', 'success');
        });
    </script>
</body>
</html>





